---
globs: *.ts
alwaysApply: false
---

# ğŸ“ Plan d'Architecture - Application Angular

**Date** : 2025  
**Version Angular** : 20.x  
**Pattern** : Standalone Components + Signals + Store Pattern

---

## ğŸ¯ Vue d'ensemble

Cette application suit une **architecture en couches** avec sÃ©paration claire des responsabilitÃ©s :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UI LAYER (Components)                    â”‚
â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              APPLICATION LAYER (Orchestration)               â”‚
â”‚  Application.ts - Coordonne le workflow via effects()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  STORE LAYER (Ã‰tat global)                   â”‚
â”‚  SearchStore (NgRx Signals) - Gestion d'Ã©tat rÃ©active      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            INFRASTRUCTURE LAYER (Appels API)                  â”‚
â”‚  Infrastructure.ts - Wrapper pour services API              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              API SERVICES LAYER (Services externes)            â”‚
â”‚  SupabaseService, OpenaiApiService, VideoService, etc.      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—ï¸ Architecture en couches dÃ©taillÃ©e

### 1ï¸âƒ£ **UI LAYER** - Composants de prÃ©sentation

**ResponsabilitÃ©** : Affichage et interaction utilisateur

**CaractÃ©ristiques** :

- âœ… Composants **standalone** (pas de modules Angular)
- âœ… Utilisation de **Signals** pour la rÃ©activitÃ©
- âœ… Injection de dÃ©pendances avec `inject()`
- âœ… Composants **lazy-loaded** pour optimiser le chargement

**Exemple** :

```typescript
@Component({
  selector: 'app-create',
  standalone: true,
  imports: [CommonModule, FormsModule, ...],
  templateUrl: './create.component.html'
})
export class CreateComponent {
  readonly store = inject(SearchStore);

  // Signals pour contrÃ´ler l'affichage
  readonly showEditor = signal(true);

  // Computed signals pour optimiser les calculs
  readonly articleStats = computed(() => {
    const article = this.store.article() || '';
    return { characters: article.length, words: ... };
  });
}
```

**Composants principaux** :

- `CreateComponent` : Point d'entrÃ©e de la feature
- `EditorComponent` : Ã‰diteur WYSIWYG
- `GenerationComponent` : Interface gÃ©nÃ©ration
- `ErrorDisplayComponent` : Affichage erreurs
- `PerformanceDisplayComponent` : MÃ©triques performance

---

### 2ï¸âƒ£ **APPLICATION LAYER** - Orchestration mÃ©tier

**ResponsabilitÃ©** : Coordonner le workflow de gÃ©nÃ©ration d'article

**Pattern** : **Facade Pattern** via `Application.ts`

**CaractÃ©ristiques** :

- âœ… Utilise `computed()` pour rÃ©agir aux changements du store
- âœ… Appelle les mÃ©thodes du store selon l'Ã©tat

---

### 3ï¸âƒ£ **STORE LAYER** - Gestion d'Ã©tat rÃ©active

**ResponsabilitÃ©** : Ã‰tat global de l'application et orchestration des appels API

**Technologie** : **NgRx Signals** (`@ngrx/signals`)

**CaractÃ©ristiques** :

- âœ… Store **signalStore** avec `withState`, `withComputed`, `withMethods`
- âœ… MÃ©thodes **rxMethod** pour intÃ©grer RxJS
- âœ… **Validation** avant chaque opÃ©ration
- âœ… **Gestion d'erreurs** centralisÃ©e (liste d'erreurs)
- âœ… **ParallÃ©lisation** avec `forkJoin` pour optimiser les performances

**Optimisations** :

- âš¡ **ParallÃ©lisation** : `forkJoin` pour exÃ©cuter plusieurs appels simultanÃ©ment
- âš¡ **Guards** : Ã‰vite les appels multiples simultanÃ©s
- âš¡ **Validation** : VÃ©rifie les prÃ©requis avant chaque opÃ©ration

---

### 4ï¸âƒ£ **INFRASTRUCTURE LAYER** - Wrapper API

**ResponsabilitÃ©** : Encapsuler les appels API et gÃ©rer les erreurs

**Pattern** : **Adapter Pattern**

**CaractÃ©ristiques** :

- âœ… Wrapper autour des services API
- âœ… **Gestion d'erreurs** standardisÃ©e (transformation en `PostgrestError`)
- âœ… **Logging** systÃ©matique
- âœ… **Mocks** pour tests (via flags `shouldReturnMock`)

**Service de performance** :

- `InfrastructurePerformanceService` : Version optimisÃ©e avec cache et retry

---

### 5ï¸âƒ£ **API SERVICES LAYER** - Services externes

**ResponsabilitÃ©** : Communication avec les APIs externes

**Services principaux** :

#### **SupabaseService**

- CRUD sur tables
- Upload images vers Supabase Storage
- Authentification

#### **OpenaiApiService**

- GÃ©nÃ©ration texte (GPT-4)
- GÃ©nÃ©ration images (DALLÂ·E 3)
- Parsing JSON sÃ©curisÃ©

#### **VideoService**

- Recherche YouTube API v3
- Extraction ID vidÃ©o

#### **PexelsApiService / UnsplashImageService**

- Recherche images libres de droits

#### **Autres services**

- `ImageUploadService` : Upload et traitement images
- `InternalImageService` : Gestion images internes

---

## ğŸ¨ Patterns et pratiques

### âœ… Patterns utilisÃ©s

1. **Standalone Components**

   - Pas de modules Angular
   - Import direct des dÃ©pendances

2. **Dependency Injection avec `inject()`**

   ```typescript
   private readonly store = inject(SearchStore);
   ```

3. **Signals pour rÃ©activitÃ©**

   ```typescript
   readonly title = signal('Mon titre');
   readonly computed = computed(() => this.title().toUpperCase());
   ```

4. **Store Pattern (NgRx Signals)**

   - Ã‰tat centralisÃ©
   - MÃ©thodes rÃ©actives avec `rxMethod`

5. **Facade Pattern**

   - `Application.ts` simplifie l'interface du store

6. **Adapter Pattern**

   - `Infrastructure.ts` adapte les services API

7. **Lazy Loading**
   - Composants chargÃ©s Ã  la demande
   - Routes avec `loadComponent()`

### âœ… Bonnes pratiques

1. **SÃ©paration des responsabilitÃ©s**

   - UI â‰  Logique mÃ©tier â‰  Appels API

2. **Type Safety**

   - Interfaces TypeScript strictes
   - Pas de `any` (sauf cas exceptionnels)

3. **Gestion d'erreurs**

   - Erreurs centralisÃ©es dans le store
   - Transformation standardisÃ©e (`PostgrestError`)

4. **Performance**

   - ParallÃ©lisation avec `forkJoin`
   - Computed signals pour Ã©viter recalculs
   - Lazy loading des composants

5. **Logging**

   - Service de logging centralisÃ©
   - Logs structurÃ©s avec contexte

6. **Tests**
   - Services testables (injection de dÃ©pendances)
   - Mocks via flags dans Infrastructure

---

## ğŸ” Authentification

**Service** : `AuthService` (dans `login/services/`)

**Guard** : `auth.guard.ts` protÃ¨ge les routes

**Flux** :

```
1. User arrive sur /login
   â†“
2. LoginComponent â†’ AuthService.signIn()
   â†“
3. Supabase authentifie
   â†“
4. Redirection vers /create (si authentifiÃ©)
   â†“
5. Routes protÃ©gÃ©es par auth.guard
```

---

## ğŸ“¦ DÃ©pendances principales

```json
{
  "@angular/core": "^20.1.0",
  "@angular/router": "^20.1.0",
  "@ngrx/signals": "^19.2.1",
  "@supabase/supabase-js": "^2.51.0",
  "rxjs": "~7.8.0",
  "openai": "^5.16.0"
}
```

---

## ğŸš€ Points d'entrÃ©e

### Application

- **Fichier principal** : `src/main.ts`
- **Composant racine** : `src/app/app.ts`
- **Configuration** : `src/app/app.config.ts`
- **Routes** : `src/app/app.routes.ts`

### Feature principale

- **Composant** : `src/app/features/XXX/create.component.ts`
- **Store** : `src/app/features/XXX/store/index.ts`
- **Orchestration** : `src/app/features/XXX/components/application/application.ts`
- **Infrastructure** : `src/app/features/XXX/components/infrastructure/infrastructure.ts`

---

## ğŸ“ Notes importantes

### âš ï¸ Points d'attention

1. **Couplage Store â†” Infrastructure**

   - Le store injecte directement `Infrastructure`
   - Pour rÃ©duire le couplage : utiliser des interfaces

2. **Effect() dans Application**

   - DÃ©pend de l'ordre d'exÃ©cution
   - Peut Ãªtre fragile si plusieurs effects

3. **Gestion d'erreurs**
   - Erreurs stockÃ©es dans une liste (`error: string[]`)
   - distinction entre erreurs critiques/non-critiques

### âœ… Points forts

1. **Architecture claire** en couches
2. **Performance optimisÃ©e** (parallÃ©lisation)
3. **Type safety** avec TypeScript
4. **RÃ©activitÃ©** avec Signals
5. **ModularitÃ©** avec features standalone

---

## ğŸ”„ Ã‰volutions possibles

1. **SÃ©parer Store et Infrastructure**

   - CrÃ©er des interfaces pour rÃ©duire le couplage
   - Utiliser des facades pour chaque domaine

2. **Error Handling**

   - Distinguer erreurs critiques/non-critiques
   - Retry automatique pour erreurs temporaires

3. **Caching**
   - Cache des rÃ©ponses API
   - Cache des images gÃ©nÃ©rÃ©es

---

## ğŸ“š RÃ©fÃ©rences

- [Angular Signals](https://angular.dev/guide/signals)
- [NgRx Signals](https://ngrx.io/guide/signals)
- [Standalone Components](https://angular.dev/guide/components/importing)
- [Supabase JS Client](https://supabase.com/docs/reference/javascript/introduction)

---

**Fin du plan d'architecture**
