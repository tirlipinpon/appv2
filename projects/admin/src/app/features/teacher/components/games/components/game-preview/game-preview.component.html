@if (isOpen()) {
  <div 
    class="preview-backdrop" 
    (click)="onBackdropClick($event)"
    (keydown.escape)="close()"
    role="dialog"
    aria-modal="true"
    tabindex="-1">
    <div class="preview-container" (click)="$event.stopPropagation()" (keydown.escape)="close()" tabindex="0">
      <div class="preview-header">
        <h2 class="preview-title">üéÆ Pr√©visualisation du jeu</h2>
        <button 
          class="preview-close"
          type="button"
          (click)="close()"
          aria-label="Fermer la pr√©visualisation">
          √ó
        </button>
      </div>

      <div class="preview-body">
        <!-- Instructions et Question -->
        @if (globalFields?.instructions) {
          <div class="game-instructions">
            <strong>Instructions:</strong> {{ globalFields?.instructions }}
          </div>
        }

        @if (globalFields?.question) {
          <div class="game-question">
            <strong>Question:</strong> {{ globalFields?.question }}
          </div>
        }

        <!-- Aides -->
        @if (hasAides()) {
          <div class="game-aides">
            <strong>Aides:</strong>
            <ul>
              @for (aide of getAides(); track aide) {
                <li>{{ aide }}</li>
              }
            </ul>
          </div>
        }

        <!-- QCM -->
        @if (qcmData) {
          <div class="preview-content qcm-preview">
            <app-qcm-game
              [qcmData]="qcmData"
              [showResult]="isSubmitted()"
              [disabled]="false"
              [aides]="globalFields?.aides || null"
              [instructions]="globalFields?.instructions || null"
              [question]="globalFields?.question || null"
              (answerSelected)="onQcmAnswerSelected($event)"
              (validated)="onQcmValidated($event)">
            </app-qcm-game>
          </div>
        }

        <!-- Case Vide -->
        @if (caseVideData) {
          <div class="preview-content case-vide-preview">
            <app-case-vide-game
              #caseVideGame
              [caseVideData]="caseVideData"
              [showResult]="isSubmitted()"
              [disabled]="false"
              [aides]="globalFields?.aides || null"
              [instructions]="globalFields?.instructions || null"
              [question]="globalFields?.question || null"
              (validated)="onCaseVideValidated($event)">
            </app-case-vide-game>
            @if (!isSubmitted()) {
              <button 
                class="btn btn-primary" 
                (click)="submitCaseVide()" 
                [disabled]="!canSubmitCaseVide()">
                Valider
              </button>
            } @else {
              <button class="btn btn-secondary" (click)="reset()">R√©essayer</button>
            }
          </div>
        }

        <!-- R√©ponse Libre -->
        @if (reponseLibreData) {
          <div class="preview-content reponse-libre-preview">
            <app-reponse-libre-game
              [reponseLibreData]="reponseLibreData"
              [showResult]="isSubmitted()"
              [disabled]="isSubmitted()"
              (validated)="onReponseLibreValidated($event)"
              (resetRequested)="reset()">
            </app-reponse-libre-game>
          </div>
        }

        <!-- Liens -->
        @if (liensData) {
          <div class="preview-content liens-preview">
            @if (isSubmitted() && isCorrect() !== null) {
              <div class="result-message" [class.correct]="isCorrect()" [class.incorrect]="!isCorrect()">
                @if (isCorrect()) {
                  ‚úÖ Tous les liens sont corrects !
                } @else {
                  ‚ùå Certains liens sont incorrects.
                }
              </div>
            }
            <div class="liens-grid-container">
              <div class="liens-grid" #liensGrid>
                <svg #linksSvg class="links-svg" xmlns="http://www.w3.org/2000/svg">
                  @for (linkPath of getLinkPaths(); track linkPath.mot + linkPath.reponse) {
                    <path 
                      [attr.d]="linkPath.path" 
                      class="link-line"
                      [class.correct]="isSubmitted() && isCorrect()"
                      [class.incorrect]="isSubmitted() && !isCorrect()"
                      fill="none"
                      stroke-width="2"
                      stroke-linecap="round">
                    </path>
                  }
                </svg>
                <div class="mots-column">
                  <h4>Mots</h4>
                  @for (mot of getLiensMots(); track mot) {
                    <div 
                      class="mot-item"
                      [attr.data-mot]="mot"
                      [class.selected]="isMotSelected(mot)"
                      [class.linked]="getReponseForMot(mot)"
                      (click)="selectMot(mot)"
                      [class.disabled]="isSubmitted()">
                      <span class="mot-text">{{ mot }}</span>
                      <span class="link-circle"></span>
                    </div>
                  }
                </div>
                <div class="reponses-column">
                  <h4>R√©ponses</h4>
                  @for (reponse of getLiensReponses(); track reponse) {
                    <div 
                      class="reponse-item"
                      [attr.data-reponse]="reponse"
                      [class.selected]="findMotForReponse(reponse) && isLinkSelected(findMotForReponse(reponse), reponse)"
                      (click)="selectReponse(reponse)"
                      [class.disabled]="isSubmitted()">
                      <span class="link-circle"></span>
                      <span class="reponse-text">{{ reponse }}</span>
                    </div>
                  }
                </div>
              </div>
            </div>
            @if (selectedMotForLink()) {
              <p class="hint">S√©lectionnez une r√©ponse pour lier avec "{{ selectedMotForLink() }}"</p>
            }
            <button class="btn btn-primary" (click)="submitLiens()" [disabled]="isSubmitted()">
              Valider
            </button>
            @if (isSubmitted()) {
              <button class="btn btn-secondary" (click)="reset()">R√©essayer</button>
            }
          </div>
        }

        <!-- Chronologie -->
        @if (chronologieData) {
          <div class="preview-content chronologie-preview">
            <app-chronologie-game
              [chronologieData]="chronologieData"
              [showResult]="isSubmitted()"
              [disabled]="false"
              [aides]="globalFields?.aides || null"
              [instructions]="globalFields?.instructions || null"
              [question]="globalFields?.question || null"
              (orderChanged)="onChronologieOrderChanged($event)"
              (validated)="onChronologieValidated($event)">
            </app-chronologie-game>
          </div>
        }

        <!-- Vrai/Faux -->
        @if (vraiFauxData) {
          <div class="preview-content vrai-faux-preview">
            @if (isSubmitted() && isCorrect() !== null) {
              <div class="result-message" [class.correct]="isCorrect()" [class.incorrect]="!isCorrect()">
                @if (isCorrect()) {
                  ‚úÖ Toutes les r√©ponses sont correctes !
                } @else {
                  ‚ùå Certaines r√©ponses sont incorrectes.
                }
              </div>
            }
            <div class="vrai-faux-grid">
              <div class="vrai-faux-header">
                <div class="header-column vrai-column">Vrai</div>
                <div class="header-column enonce-column"></div>
                <div class="header-column faux-column">Faux</div>
              </div>
              @for (enonce of getVraiFauxEnonces(); track $index) {
                <div class="vrai-faux-row">
                  <button
                    type="button"
                    class="vrai-button"
                    [class.selected]="isVraiFauxAnswerSelected($index, true)"
                    [class.correct]="isSubmitted() && isVraiFauxCorrect($index) === true && isVraiFauxAnswerSelected($index, true)"
                    [class.incorrect]="isSubmitted() && isVraiFauxCorrect($index) === false && isVraiFauxAnswerSelected($index, true)"
                    (click)="selectVraiFauxAnswer($index, true)"
                    [disabled]="isSubmitted()">
                    <span class="circle"></span>
                  </button>
                  <div class="enonce-text">{{ enonce.texte }}</div>
                  <button
                    type="button"
                    class="faux-button"
                    [class.selected]="isVraiFauxAnswerSelected($index, false)"
                    [class.correct]="isSubmitted() && isVraiFauxCorrect($index) === true && isVraiFauxAnswerSelected($index, false)"
                    [class.incorrect]="isSubmitted() && isVraiFauxCorrect($index) === false && isVraiFauxAnswerSelected($index, false)"
                    (click)="selectVraiFauxAnswer($index, false)"
                    [disabled]="isSubmitted()">
                    <span class="circle"></span>
                  </button>
                </div>
              }
            </div>
            <button 
              class="btn btn-primary" 
              (click)="submitVraiFaux()" 
              [disabled]="isSubmitted() || userVraiFauxAnswers().size !== getVraiFauxEnonces().length">
              Valider
            </button>
            @if (isSubmitted()) {
              <button class="btn btn-secondary" (click)="reset()">R√©essayer</button>
            }
          </div>
        }

        <!-- Memory -->
        @if (memoryData) {
          <div class="preview-content memory-preview">
            @if (isSubmitted() && isCorrect() !== null) {
              <div class="result-message" [class.correct]="isCorrect()" [class.incorrect]="!isCorrect()">
                @if (isCorrect()) {
                  ‚úÖ Toutes les paires ont √©t√© trouv√©es !
                } @else {
                  ‚ùå Le jeu n'est pas encore termin√©.
                }
              </div>
            }
            <app-memory-game
              [memoryData]="memoryData"
              [showResult]="isSubmitted()"
              [disabled]="false"
              [aides]="globalFields?.aides || null"
              [instructions]="globalFields?.instructions || null"
              [question]="globalFields?.question || null"
              (validated)="onMemoryValidated($event)">
            </app-memory-game>
            @if (isSubmitted()) {
              <button class="btn btn-secondary" (click)="reset()">R√©essayer</button>
            }
          </div>
        }

        <!-- Simon -->
        @if (simonData) {
          <div class="preview-content simon-preview">
            <app-simon-game
              [simonData]="simonData"
              [showResult]="isSubmitted()"
              [disabled]="false"
              [aides]="globalFields?.aides || null"
              [instructions]="globalFields?.instructions || null"
              [question]="globalFields?.question || null"
              (validated)="onSimonValidated($event)">
            </app-simon-game>
          </div>
        }

        <!-- Image Interactive (Click) -->
        @if (imageInteractiveData) {
          <div class="preview-content image-interactive-preview">
            <app-image-interactive-game
              [imageData]="imageInteractiveData"
              [showResult]="isSubmitted()"
              [disabled]="false"
              [aides]="globalFields?.aides || null"
              [instructions]="globalFields?.instructions || null"
              [question]="globalFields?.question || null"
              (validated)="onImageInteractiveValidated($event)">
            </app-image-interactive-game>
          </div>
        }

        <!-- Puzzle -->
        @if (puzzleData) {
          <div class="preview-content puzzle-preview">
            <app-puzzle-game
              [puzzleData]="puzzleData"
              [showResult]="isSubmitted()"
              [disabled]="false"
              [aides]="globalFields?.aides || null"
              [instructions]="globalFields?.instructions || null"
              [question]="globalFields?.question || null"
              (validated)="onPuzzleValidated($event)"
              (resetRequested)="reset()"
              (nextRequested)="reset()">
            </app-puzzle-game>
          </div>
        }
      </div>

      <div class="preview-footer">
        <button class="btn btn-secondary" (click)="close()">Fermer</button>
      </div>
    </div>
  </div>
}

