<div class="ai-generator-form">
  <h3>G√©n√©ration de jeux par IA</h3>

  <div *ngIf="schoolYearLabel" class="school-year-info">
    <span class="label">Niveau scolaire d√©tect√©:</span>
    <span class="value">{{ schoolYearLabel }}</span>
  </div>

  <div *ngIf="!schoolYearLabel" class="warning-message warning-no-assignment">
    ‚ö†Ô∏è Aucune affectation d√©tect√©e pour cette mati√®re. 
    <a routerLink="/teacher-subjects/assignments" class="link-primary">Cr√©er une affectation</a> 
    ou s√©lectionnez un niveau manuellement ci-dessous.
  </div>

  <form [formGroup]="generatorForm" (ngSubmit)="onSubmit()">
    <div class="form-group" *ngIf="!schoolYearLabel">
      <label for="manualSchoolLevel">Niveau scolaire *</label>
      <select 
        id="manualSchoolLevel" 
        formControlName="manualSchoolLevel"
        required
      >
        <option value="">S√©lectionner un niveau...</option>
        <option *ngFor="let level of availableSchoolLevels" [value]="level.value">{{ level.label }}</option>
      </select>
      <small>Ce niveau sera utilis√© pour adapter les jeux g√©n√©r√©s</small>
    </div>

    <div class="form-group">
      <label for="subject">Th√®me/Sujet du jeu *</label>
      <input 
        type="text" 
        id="subject" 
        formControlName="subject" 
        placeholder="Ex: Les fractions, La R√©volution fran√ßaise, Les tables de multiplication..."
      />
      <small *ngIf="subjectName" class="form-hint">Pour la mati√®re : <strong>{{ subjectName }}</strong></small>
      <span class="error-message" *ngIf="generatorForm.get('subject')?.hasError('required') && generatorForm.get('subject')?.touched">
        Le th√®me/sujet est requis
      </span>
      <span class="error-message" *ngIf="generatorForm.get('subject')?.hasError('minlength') && generatorForm.get('subject')?.touched">
        Le th√®me/sujet doit contenir au moins 3 caract√®res
      </span>
    </div>

    <div class="form-group" *ngIf="gameTypes.length > 0">
      <div class="form-label">Types de jeux (optionnel)</div>
      <div class="game-types-selection">
        <div class="selection-info">
          <small>
            <span *ngIf="selectedGameTypeIds().length === 0">
              Aucun type s√©lectionn√© - L'IA choisira parmi tous les types disponibles
            </span>
            <span *ngIf="selectedGameTypeIds().length > 0">
              {{ selectedGameTypeIds().length }} type(s) s√©lectionn√©(s)
            </span>
          </small>
        </div>
        <div class="game-types-grid">
          <label 
            *ngFor="let gameType of gameTypes" 
            class="game-type-checkbox"
            [class.disabled]="isGenerating"
            [class.game-type-qcm]="gameType.name.toLowerCase() === 'qcm'"
            [class.game-type-case-vide]="gameType.name.toLowerCase() === 'case vide'"
            [class.game-type-reponse-libre]="gameType.name.toLowerCase() === 'reponse libre'"
            [class.game-type-liens]="gameType.name.toLowerCase() === 'liens'"
            [class.game-type-chronologie]="gameType.name.toLowerCase() === 'chronologie'"
            [class.game-type-vrai-faux]="gameType.name.toLowerCase() === 'vrai/faux'"
            [class.game-type-memory]="gameType.name.toLowerCase() === 'memory'"
            [class.game-type-simon]="gameType.name.toLowerCase() === 'simon'"
          >
            <input 
              type="checkbox" 
              [checked]="isGameTypeSelected(gameType.id)"
              (change)="toggleGameType(gameType.id)"
              [disabled]="isGenerating"
            />
            <div class="game-type-info">
              <span class="game-type-name">{{ gameType.name }}</span>
              <small class="game-type-description" *ngIf="gameType.description">
                {{ gameType.description }}
              </small>
            </div>
          </label>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label for="pdfFile">Document PDF (optionnel)</label>
      <div class="file-upload-zone">
        <input 
          type="file" 
          id="pdfFile" 
          accept="application/pdf"
          (change)="onFileSelected($event)"
        />
        <div *ngIf="!selectedFile()" class="file-placeholder">
          <span>üìÑ Joindre un PDF pour fournir du contexte √† l'IA</span>
          <small>Maximum 10MB</small>
        </div>
        <div *ngIf="selectedFile()" class="file-selected">
          <span>{{ selectedFile()!.name }}</span>
          <button type="button" class="btn-remove" (click)="removeFile()" [disabled]="isGenerating">√ó</button>
        </div>
      </div>
      <span class="error-message" *ngIf="fileError()">{{ fileError() }}</span>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="numberOfGames">Nombre de jeux *</label>
        <input 
          type="number" 
          id="numberOfGames" 
          formControlName="numberOfGames"
          min="1"
          max="20"
        />
        <small>Entre 1 et 20 jeux</small>
      </div>

      <div class="form-group">
        <label for="difficulty">
          Difficult√©: {{ getDifficultyLabel(generatorForm.get('difficulty')?.value || 3) }}
        </label>
        <input 
          type="range" 
          id="difficulty" 
          formControlName="difficulty"
          min="1"
          max="5"
          step="1"
        />
        <div class="difficulty-labels">
          <span>Facile</span>
          <span>Difficile</span>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button 
        type="submit" 
        class="btn btn-primary btn-generate"
        [disabled]="generatorForm.invalid || isGenerating || (!schoolYearLabel && !generatorForm.get('manualSchoolLevel')?.value)"
      >
        <span *ngIf="!isGenerating">ü§ñ G√©n√©rer avec l'IA</span>
        <span *ngIf="isGenerating">
          ‚è≥ G√©n√©ration en cours... 
          <span class="progress-text">({{ generatedCount }}/{{ generatorForm.value.numberOfGames }} jeux - {{ generationProgress }}%)</span>
        </span>
      </button>
      
      <!-- Barre de progression -->
      <div *ngIf="isGenerating" class="progress-bar-container">
        <div class="progress-bar" [style.width.%]="generationProgress"></div>
      </div>
    </div>
  </form>
</div>

