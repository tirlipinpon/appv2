<div class="games-container">
  <a (click)="navigateToSubject($event)" class="btn-back">‚Üê Retour √† la mati√®re</a>
  <h1>Gestion des jeux</h1>
  
  @if (currentSubjectName()) {
    <div class="subject-info">
      <h2>Mati√®re : {{ currentSubjectName() }}</h2>
      @if (selectedCategoryId() && categories().length > 0) {
        @for (category of categories(); track category.id) {
          @if (category.id === selectedCategoryId()) {
            <p class="category-info">Sous-cat√©gorie : <strong>{{ category.name }}</strong></p>
          }
        }
      }
    </div>
  }

  <!-- Section G√©n√©ration IA -->
  <section class="ai-generation-section collapsible-section">
    <div class="section-header" (click)="toggleAIGeneration()">
      <h3>ü§ñ G√©n√©ration de jeux par IA</h3>
      <button type="button" class="toggle-btn" [attr.aria-expanded]="isAIGenerationExpanded()">
        {{ isAIGenerationExpanded() ? '‚àí' : '+' }}
      </button>
    </div>
    @if (isAIGenerationExpanded()) {
      <div class="section-content">
        <app-ai-game-generator-form
          [subjectId]="subjectId()!"
          [subjectName]="currentSubjectName()"
          [schoolYearLabel]="schoolYearLabel()"
          [isGenerating]="isGenerating()"
          [generationProgress]="generationProgress()"
          [generatedCount]="generatedGames().length"
          [gameTypes]="gameTypes()"
          (generate)="onGenerateGamesWithAI($event)">
        </app-ai-game-generator-form>

        <app-ai-generated-preview
          [generatedGames]="generatedGames()"
          [gameTypes]="gameTypes()"
          (edit)="onEditGeneratedGame($event)"
          (remove)="onRemoveGeneratedGame($event)"
          (updateGame)="onUpdateGeneratedGame($event)"
          (saveAll)="onSaveAllGeneratedGames()"
          (cancelAll)="onCancelAllGeneratedGames()">
        </app-ai-generated-preview>
      </div>
    }
  </section>

  <div class="game-form-section collapsible-section">
    <div class="section-header" 
         (click)="toggleManualCreation()"
         [class.game-type-qcm]="selectedGameTypeName()?.toLowerCase() === 'qcm'"
         [class.game-type-case-vide]="selectedGameTypeName()?.toLowerCase() === 'case vide'"
         [class.game-type-reponse-libre]="selectedGameTypeName()?.toLowerCase() === 'reponse libre'"
         [class.game-type-liens]="selectedGameTypeName()?.toLowerCase() === 'liens'"
         [class.game-type-chronologie]="selectedGameTypeName()?.toLowerCase() === 'chronologie'"
         [class.game-type-vrai-faux]="selectedGameTypeName()?.toLowerCase() === 'vrai/faux'"
         [class.game-type-memory]="selectedGameTypeName()?.toLowerCase() === 'memory'"
         [class.game-type-simon]="selectedGameTypeName()?.toLowerCase() === 'simon'">
      <h3>{{ isEditing() ? '‚úèÔ∏è Modifier le jeu' : '‚ûï Cr√©er un nouveau jeu' }}</h3>
      <button type="button" class="toggle-btn" [attr.aria-expanded]="isManualCreationExpanded()">
        {{ isManualCreationExpanded() ? '‚àí' : '+' }}
      </button>
    </div>
    @if (isManualCreationExpanded()) {
      <div class="section-content">
        <form [formGroup]="gameForm" (ngSubmit)="isEditing() ? update() : create()">
      <div class="form-group">
        <label for="game_type_id">Type de jeu *</label>
        <select id="game_type_id" formControlName="game_type_id" (change)="onGameTypeChange()">
          <option value="">S√©lectionner un type</option>
          @for (gt of gameTypes(); track gt.id) {
            <option [value]="gt.id">{{ gt.name }}</option>
          }
        </select>
        @if (gameForm.get('game_type_id')?.hasError('required') && gameForm.get('game_type_id')?.touched) {
          <span class="error-message">
            Le type de jeu est requis.
          </span>
        }
      </div>

      <div class="form-group">
        <label for="category_id">Sous-cat√©gorie (optionnel)</label>
        @if (isCategoryContext()) {
          <!-- Mode "gestion d'une sous-cat√©gorie sp√©cifique" : champ d√©sactiv√© -->
          <select 
            id="category_id" 
            [value]="selectedCategoryId() || ''"
            disabled>
            @if (selectedCategoryId() && categories().length > 0) {
              @for (category of categories(); track category.id) {
                @if (category.id === selectedCategoryId()) {
                  <option [value]="category.id">{{ category.name }}</option>
                }
              }
            } @else {
              <option value="">Sous-cat√©gorie s√©lectionn√©e</option>
            }
          </select>
          <small class="form-hint">
            <strong>Mode sous-cat√©gorie :</strong> Les jeux cr√©√©s seront automatiquement li√©s √† cette sous-cat√©gorie.
          </small>
        } @else if (categories().length > 0) {
          <!-- Mode normal : on peut choisir la sous-cat√©gorie -->
          <select 
            id="category_id" 
            [value]="selectedCategoryId() || ''"
            (change)="onCategoryChange($any($event.target).value || null)">
            <option value="">Aucune (jeu directement sur la mati√®re)</option>
            @for (category of categories(); track category.id) {
              <option [value]="category.id">{{ category.name }}</option>
            }
          </select>
          <small class="form-hint">Si vous s√©lectionnez une sous-cat√©gorie, le jeu sera li√© √† cette sous-cat√©gorie plut√¥t qu'√† la mati√®re directement. Sinon, le jeu sera li√© directement √† la mati√®re.</small>
        } @else {
          <!-- Aucune sous-cat√©gorie disponible -->
          <select 
            id="category_id" 
            [value]="''"
            disabled>
            <option value="">Aucune sous-cat√©gorie disponible</option>
          </select>
          <small class="form-hint">
            <strong>Note :</strong> Le jeu sera cr√©√© directement pour la mati√®re. Pour cr√©er des sous-cat√©gories, allez dans la page de gestion de la mati√®re.
          </small>
        }
      </div>

      <!-- Champs globaux (instructions, question, aides) -->
      <app-game-global-fields
        [initialData]="initialGlobalFields()"
        (dataChange)="onGlobalFieldsChange($event)"
        (validityChange)="onGlobalFieldsValidityChange()">
      </app-game-global-fields>

      <!-- Composants sp√©cifiques selon le type de jeu -->
      @if (selectedGameTypeName()) {
        <div class="game-specific-form">
          <!-- Case vide -->
          @if (normalizeGameTypeName(selectedGameTypeName()) === 'case vide') {
            <app-case-vide-form
              [initialData]="getInitialDataForCaseVide()"
              (dataChange)="onGameDataChange($event)"
              (validityChange)="onGameValidityChange($event)">
            </app-case-vide-form>
          }

          <!-- R√©ponse libre -->
          @if (normalizeGameTypeName(selectedGameTypeName()) === 'reponse libre') {
            <app-reponse-libre-form
              [initialData]="getInitialDataForReponseLibre()"
              (dataChange)="onGameDataChange($event)"
              (validityChange)="onGameValidityChange($event)">
            </app-reponse-libre-form>
          }

          <!-- Liens -->
          @if (normalizeGameTypeName(selectedGameTypeName()) === 'liens') {
            <app-liens-form
              [initialData]="getInitialDataForLiens()"
              (dataChange)="onGameDataChange($event)"
              (validityChange)="onGameValidityChange($event)">
            </app-liens-form>
          }

          <!-- Chronologie -->
          @if (normalizeGameTypeName(selectedGameTypeName()) === 'chronologie') {
            <app-chronologie-form
              [initialData]="getInitialDataForChronologie()"
              (dataChange)="onGameDataChange($event)"
              (validityChange)="onGameValidityChange($event)">
            </app-chronologie-form>
          }

          <!-- QCM -->
          @if (normalizeGameTypeName(selectedGameTypeName()) === 'qcm') {
            <app-qcm-form
              [initialData]="getInitialDataForQcm()"
              (dataChange)="onGameDataChange($event)"
              (validityChange)="onGameValidityChange($event)">
            </app-qcm-form>
          }

          <!-- Vrai/Faux -->
          @if (selectedGameTypeName()?.toLowerCase() === 'vrai/faux') {
            <app-vrai-faux-form
              [initialData]="getInitialDataForVraiFaux()"
              (dataChange)="onGameDataChange($event)"
              (validityChange)="onGameValidityChange($event)">
            </app-vrai-faux-form>
          }

          <!-- Memory -->
          @if (selectedGameTypeName()?.toLowerCase() === 'memory') {
            <app-memory-form
              [initialData]="getInitialDataForMemory()"
              (dataChange)="onGameDataChange($event)"
              (validityChange)="onGameValidityChange($event)">
            </app-memory-form>
          }

          <!-- Simon -->
          @if (selectedGameTypeName()?.toLowerCase() === 'simon') {
            <app-simon-form
              [initialData]="getInitialDataForSimon()"
              (dataChange)="onGameDataChange($event)"
              (validityChange)="onGameValidityChange($event)">
            </app-simon-form>
          }

          <!-- Image Interactive (Click) -->
          @if (selectedGameTypeName()?.toLowerCase() === 'click') {
            <app-image-interactive-form
              [initialData]="initialDataForImageInteractive()"
              (dataChange)="onGameDataChange($event)"
              (validityChange)="onGameValidityChange($event)">
            </app-image-interactive-form>
          }
        </div>
      }

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" [disabled]="gameForm.invalid || isLoading() || !gameSpecificValid()">
          {{ isEditing() ? 'Enregistrer' : 'Cr√©er' }}
        </button>
          @if (isEditing()) {
            <button type="button" class="btn btn-secondary" (click)="cancelEdit()">
              Annuler
            </button>
          }
        </div>
      </form>
    </div>
    }
  </div>

  <!-- Section Liste des jeux avec toggle -->
  <section class="games-list-section collapsible-section">
    <div class="section-header" (click)="toggleGamesList()">
      <h3>üìã Mes jeux ({{ games().length }})</h3>
      <button type="button" class="toggle-btn" [attr.aria-expanded]="isGamesListExpanded()">
        {{ isGamesListExpanded() ? '‚àí' : '+' }}
      </button>
    </div>
    @if (isGamesListExpanded()) {
      <div class="section-content">
        @if (isLoading()) {
          <div class="loading">Chargement...</div>
        }
        @if (!isLoading() && games().length === 0) {
          <div class="empty-state">
            <p>Aucun jeu cr√©√© pour cette mati√®re.</p>
          </div>
        }
        @if (!isLoading() && games().length > 0) {
          <ul class="games-list">
            @for (game of games(); track game.id) {
              <app-game-card
                [game]="game"
                [gameTypeName]="getGameTypeName(game.game_type_id)"
                [gameTypes]="gameTypes()"
                (update)="updateGameFromCard($event.gameId, $event.updates)"
                (delete)="delete($event)"
                (duplicate)="openDuplicateDialog($event)">
              </app-game-card>
            }
          </ul>
        }
      </div>
    }
  </section>

  <!-- Dialog de duplication -->
  @if (duplicateDialogOpen() && gameToDuplicate()) {
    <app-duplicate-game-dialog
      [game]="gameToDuplicate()!"
      [currentAssignment]="currentAssignment()"
      [availableSchools]="availableSchoolsForTeacher()"
      [availableAssignments]="subjectsStore.assignments()"
      [availableSubjects]="subjects()"
      [gameTypes]="gameTypes()"
      [gameTypeName]="getGameTypeName(gameToDuplicate()!.game_type_id)"
      (confirm)="onDuplicateGame($event)"
      (cancel)="onCancelDuplicate()">
    </app-duplicate-game-dialog>
  }
</div>
