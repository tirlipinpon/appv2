<div class="image-interactive-form">
  <form [formGroup]="form">
    <!-- Upload d'image -->
    <div class="upload-section">
      <label for="imageFile" class="upload-label">
        <span class="upload-icon">üì∑</span>
        <span>T√©l√©charger une image</span>
      </label>
      <input
        type="file"
        id="imageFile"
        accept="image/jpeg,image/jpg,image/png,image/webp,image/gif"
        (change)="onFileSelected($event)"
        class="file-input"
      />
      @if (imageUrl()) {
        <p class="image-info">
          Image charg√©e : {{ imageWidth() }} √ó {{ imageHeight() }}px
        </p>
      }
    </div>

    <!-- Conteneur de l'image avec zones -->
    @if (imageUrl()) {
      <div class="image-editor">
        <div class="editor-controls">
          <button
            type="button"
            class="btn-mode"
            [class.active]="editMode() === 'draw'"
            (click)="editMode.set('draw')"
            title="Dessiner une zone"
          >
            ‚úèÔ∏è
          </button>
          <button
            type="button"
            class="btn-mode"
            [class.active]="editMode() === 'select'"
            (click)="editMode.set('select')"
            title="S√©lectionner"
          >
            üëÜ
          </button>
          
          <!-- Contr√¥les pour finaliser le polygone en cours -->
          @if (isCreatingPolygon()) {
            <button
              type="button"
              class="btn-mode btn-confirm"
              (click)="finalizePolygon()"
              [disabled]="polygonPoints().length < 3"
              [title]="'Finaliser le polygone (' + polygonPoints().length + ' points, minimum 3)'"
            >
              ‚úì
            </button>
            <button
              type="button"
              class="btn-mode btn-cancel"
              (click)="cancelPolygon()"
              title="Annuler"
            >
              ‚úó
            </button>
            @if (polygonPoints().length > 0) {
              <button
                type="button"
                class="btn-mode btn-undo"
                (click)="removeLastPolygonPoint()"
                title="Retirer le dernier point"
              >
                ‚Ü∂
              </button>
            }
          }
        </div>

        <div
          #imageContainer
          class="image-container"
          (mousedown)="onMouseDown($event)"
          (mousemove)="onMouseMove($event)"
          (mouseup)="onMouseUp($event)"
          (mouseleave)="onMouseLeave()"
          [style.pointer-events]="editMode() === 'select' && selectedZoneId() ? 'none' : 'auto'"
        >
          <img
            #imageElement
            [src]="imageUrl()!"
            [alt]="'Image interactive'"
            class="game-image"
            (load)="updateImageDimensions()"
          />

          <!-- Overlay des zones -->
          <div #zonesOverlay class="zones-overlay">
            <!-- SVG pour les polygones -->
            <svg class="zones-svg" 
                 [style.width.px]="displayedImageWidth()" 
                 [style.height.px]="displayedImageHeight()" 
                 [style.left.px]="imageOffsetX()" 
                 [style.top.px]="imageOffsetY()">
              
              
              <!-- Polygone en cours de cr√©ation -->
              @if (isCreatingPolygon() && polygonPoints().length > 0) {
                @if (getCurrentPolygonAbsolutePoints(); as previewPoints) {
                  @if (previewPoints && previewPoints.length >= 2) {
                    <polyline
                      [attr.points]="formatPolygonPoints(previewPoints)"
                      class="zone-polygon zone-preview"
                      fill="none"
                      stroke="rgb(59, 130, 246)"
                      stroke-width="2"
                      stroke-dasharray="5,5"
                      pointer-events="none"
                    />
                  }
                  @if (previewPoints && previewPoints.length > 0) {
                    @for (point of previewPoints; track $index) {
                      <circle
                        [attr.cx]="point.x"
                        [attr.cy]="point.y"
                        r="5"
                        fill="rgb(59, 130, 246)"
                        stroke="white"
                        stroke-width="2"
                        pointer-events="none"
                      />
                    }
                  }
                }
              }
              
              <!-- Polygones existants -->
              @for (zone of zones(); track zone.id) {
                @if (!isRectangle(zone)) {
                  @if (absolutePolygonPointsCache()[zone.id]; as polygonPoints) {
                    @if (polygonPoints && polygonPoints.length > 0) {
                      <g
                        [class.selected]="isZoneSelected(zone.id)"
                        [class.correct]="zone.is_correct"
                        [class.incorrect]="!zone.is_correct"
                        (click)="selectZone(zone.id)"
                        [style.cursor]="editMode() === 'select' && isZoneSelected(zone.id) ? 'move' : 'pointer'"
                      >
                        <polygon
                          [attr.points]="formatPolygonPoints(polygonPoints)"
                          class="zone-polygon"
                          [attr.fill]="zone.is_correct ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)'"
                          [attr.stroke]="zone.is_correct ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)'"
                          stroke-width="2"
                          pointer-events="all"
                        />
                        @if (isZoneSelected(zone.id)) {
                          @for (point of absolutePolygonPointsCache()[zone.id] || []; track point.id; let i = $index) {
                            @if (isDraggingPoint() && draggingPoint()?.zoneId === zone.id && draggingPoint()?.pointIndex === i && draggingPointAbsolutePosition(); as dragPos) {
                              <circle
                                [attr.cx]="dragPos.x"
                                [attr.cy]="dragPos.y"
                                r="6"
                                fill="rgb(59, 130, 246)"
                                stroke="white"
                                stroke-width="2"
                                pointer-events="all"
                              />
                            } @else {
                              <circle
                                [attr.cx]="point.x"
                                [attr.cy]="point.y"
                                r="6"
                                fill="rgb(59, 130, 246)"
                                stroke="white"
                                stroke-width="2"
                                pointer-events="all"
                                (mousedown)="onCircleMouseDown($event, zone.id, i); $event.stopPropagation()"
                              />
                            }
                          }
                        }
                      </g>
                    }
                  }
                }
              }
            </svg>
            
            <!-- Zones rectangulaires existantes (r√©trocompatibilit√©) -->
            @for (zone of zones(); track zone.id) {
              @if (isRectangle(zone) && getAbsolutePosition(zone); as pos) {
                <div
                  class="zone"
                  [class.selected]="isZoneSelected(zone.id)"
                  [class.correct]="zone.is_correct"
                  [class.incorrect]="!zone.is_correct"
                  [class.moving]="isMoving() && isZoneSelected(zone.id)"
                  [style.left.px]="pos.x"
                  [style.top.px]="pos.y"
                  [style.width.px]="pos.width"
                  [style.height.px]="pos.height"
                  (click)="selectZone(zone.id)"
                  [style.cursor]="editMode() === 'select' && isZoneSelected(zone.id) ? 'move' : 'default'"
                >
                  <div class="zone-label">
                    {{ zone.name || 'Zone' }}
                  </div>
                  <div class="zone-actions">
                    <button
                      type="button"
                      class="btn-zone-action"
                      [title]="zone.is_correct ? 'Marquer comme incorrecte' : 'Marquer comme correcte'"
                      (click)="toggleZoneCorrect(zone.id); $event.stopPropagation()"
                    >
                      {{ zone.is_correct ? '‚úì' : '‚úó' }}
                    </button>
                    <button
                      type="button"
                      class="btn-zone-action btn-delete"
                      title="Supprimer la zone"
                      (click)="deleteZone(zone.id); $event.stopPropagation()"
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                  
                  <!-- Poign√©es de redimensionnement (seulement en mode select et si la zone est s√©lectionn√©e) -->
                  @if (editMode() === 'select' && isZoneSelected(zone.id)) {
                    <div
                      class="resize-handle resize-handle-nw"
                      (mousedown)="onResizeHandleMouseDown($event, 'nw'); $event.stopPropagation()"
                      title="Redimensionner (coin nord-ouest)"
                    ></div>
                    <div
                      class="resize-handle resize-handle-ne"
                      (mousedown)="onResizeHandleMouseDown($event, 'ne'); $event.stopPropagation()"
                      title="Redimensionner (coin nord-est)"
                    ></div>
                    <div
                      class="resize-handle resize-handle-sw"
                      (mousedown)="onResizeHandleMouseDown($event, 'sw'); $event.stopPropagation()"
                      title="Redimensionner (coin sud-ouest)"
                    ></div>
                    <div
                      class="resize-handle resize-handle-se"
                      (mousedown)="onResizeHandleMouseDown($event, 'se'); $event.stopPropagation()"
                      title="Redimensionner (coin sud-est)"
                    ></div>
                  }
                </div>
              }
            }
          </div>
        </div>

        <!-- Liste des zones -->
        @if (zones().length > 0) {
          <div class="zones-list">
            <h4>Zones d√©finies ({{ zones().length }})</h4>
            <ul>
              @for (zone of zones(); track zone.id) {
                <li
                  class="zone-item"
                  [class.selected]="isZoneSelected(zone.id)"
                  [class.correct]="zone.is_correct"
                  [class.incorrect]="!zone.is_correct"
                  tabindex="0"
                  role="button"
                  [attr.aria-label]="'S√©lectionner la zone ' + (zone.name || 'sans nom')"
                  (click)="selectZone(zone.id)"
                  (keydown.enter)="selectZone(zone.id)"
                  (keydown.space)="selectZone(zone.id); $event.preventDefault()"
                >
                  <span class="zone-name">{{ zone.name || 'Zone sans nom' }}</span>
                  <span class="zone-status">
                    {{ zone.is_correct ? '‚úì Correcte' : '‚úó Incorrecte' }}
                  </span>
                  <div class="zone-item-actions">
                    <button
                      type="button"
                      class="btn-toggle-correct"
                      [title]="zone.is_correct ? 'Marquer comme incorrecte' : 'Marquer comme correcte'"
                      (click)="toggleZoneCorrect(zone.id); $event.stopPropagation()"
                    >
                      {{ zone.is_correct ? '‚úì' : '‚úó' }}
                    </button>
                    <button
                      type="button"
                      class="btn-delete-small"
                      title="Supprimer la zone"
                      (click)="deleteZone(zone.id); $event.stopPropagation()"
                    >
                      Supprimer
                    </button>
                  </div>
                </li>
              }
            </ul>
            <div class="validation-config">
              <label class="validation-config-label">
                <input
                  type="checkbox"
                  [checked]="requireAllCorrectZones()"
                  (change)="onRequireAllCorrectZonesChange($any($event.target).checked)"
                  class="validation-config-checkbox"
                />
                <span class="validation-config-text">
                  Toutes les zones correctes sont obligatoires
                </span>
              </label>
              <p class="validation-config-help">
                @if (requireAllCorrectZones()) {
                  Le joueur devra cliquer sur toutes les zones correctes pour gagner.
                } @else {
                  Le joueur devra cliquer sur au moins une zone correcte pour gagner.
                }
              </p>
            </div>
            <p class="help-text">
              üí° Astuce : Cliquez sur "Dessiner une zone" puis cliquez plusieurs fois sur l'image pour cr√©er un polygone personnalis√©. Cliquez sur "Finaliser" pour terminer le polygone (minimum 3 points). Vous pouvez d√©finir plusieurs zones correctes en cliquant sur le bouton ‚úì/‚úó pour chaque zone.
            </p>
          </div>
        } @else {
          <p class="help-text">
            üí° T√©l√©chargez une image puis dessinez des zones cliquables dessus.
          </p>
        }
      </div>
    }
  </form>
</div>

