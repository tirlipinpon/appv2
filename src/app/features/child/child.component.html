<div class="child-container">
  <div class="header-actions">
    <a routerLink="/dashboard" class="btn-back">
      ← Retour au dashboard
    </a>
    <h1>Profil Enfant</h1>
  </div>

  @if (isLoading() && !showForm() && !showCopySelection()) {
    <div class="loading">Chargement...</div>
  }


  @if (showSuccess()) {
    <div class="success-message">
      <p>✅ {{ isCreating() ? 'Profil créé avec succès !' : 'Profil mis à jour avec succès !' }}</p>
    </div>
  }

  @if (showCopySelection() && !isLoading()) {
    <div class="copy-selection">
      <h2>Créer un nouvel enfant</h2>
      <p>Comment souhaitez-vous créer ce nouvel enfant ?</p>
      <div class="selection-options">
        <button type="button" (click)="selectCreateFromScratch()" class="btn btn-primary btn-large">
          ✨ Créer depuis zéro
        </button>
        <div class="divider">
          <span>ou</span>
        </div>
        <div class="copy-from-list">
          <p>Copier depuis un enfant existant :</p>
                  <div class="children-list">
                    @for (child of children(); track child.id) {
                      <button 
                        type="button" 
                        (click)="selectCopyFrom(child.id)" 
                        class="btn btn-secondary child-card"
                        [class.inactive-child]="!child.is_active">
                        <span class="child-name">
                          {{ child.firstname }} {{ child.lastname }}
                          @if (!child.is_active) {
                            <span class="inactive-badge-small">(Désactivé)</span>
                          }
                        </span>
                        <span class="child-info">Enfant</span>
                      </button>
                    }
                  </div>
        </div>
      </div>
    </div>
  }

  @if (showForm() && !showCopySelection()) {
    @if (sourceChildId() !== null) {
      <div class="copy-warning">
        <p>⚠️ Vous créez un nouvel enfant en copiant depuis un enfant existant. <strong>Vous devez modifier au moins le prénom ou un autre champ.</strong></p>
      </div>
    }
    @if (selectedChild() && !selectedChild()?.is_active && !isCreating()) {
      <div class="inactive-warning">
        <p>⚠️ <strong>Cet enfant est actuellement désactivé.</strong> Vous pouvez le modifier et le réactiver depuis le dashboard.</p>
      </div>
    }
    <form [formGroup]="childForm" (ngSubmit)="onSubmit()" class="child-form">
      <div class="form-group">
        <label for="firstname">Prénom *</label>
        <input
          id="firstname"
          type="text"
          formControlName="firstname"
          class="form-control"
          [class.invalid]="childForm.get('firstname')?.invalid && childForm.get('firstname')?.touched"
          [placeholder]="sourceChildId() !== null ? 'Le prénom doit être différent de l\'enfant source' : ''"
        />
        @if (childForm.get('firstname')?.invalid && childForm.get('firstname')?.touched) {
          <span class="error-text">
            @if (childForm.get('firstname')?.errors?.['sameAsSource']) {
              Le prénom doit être différent de l'enfant source
            } @else {
              Le prénom est requis
            }
          </span>
        }
      </div>

      <div class="form-group">
        <label for="lastname">Nom *</label>
        <input
          id="lastname"
          type="text"
          formControlName="lastname"
          class="form-control"
          [class.invalid]="childForm.get('lastname')?.invalid && childForm.get('lastname')?.touched"
        />
        @if (childForm.get('lastname')?.invalid && childForm.get('lastname')?.touched) {
          <span class="error-text">Le nom est requis</span>
        }
      </div>

      <div class="form-group">
        <label for="birthdate">Date de naissance</label>
        <input
          id="birthdate"
          type="text"
          formControlName="birthdate"
          class="form-control"
          placeholder="jj/mm/aaaa"
          (input)="onBirthdateInput($event)"
          [class.invalid]="childForm.get('birthdate')?.invalid && childForm.get('birthdate')?.touched"
        />
        @if (childForm.get('birthdate')?.invalid && childForm.get('birthdate')?.touched) {
          <span class="error-text">
            Le format de date doit être jj/mm/aaaa (ex: 15/03/2015)
          </span>
        }
      </div>

      <div class="form-group">
        <label for="gender">Genre</label>
        <select
          id="gender"
          formControlName="gender"
          class="form-control">
          <option value="">Sélectionner...</option>
          <option value="male">Masculin</option>
          <option value="female">Féminin</option>
          <option value="other">Autre</option>
        </select>
      </div>

      <div class="form-group">
        <label for="school_id">École</label>
        <select
          id="school_id"
          formControlName="school_id"
          class="form-control">
          <option value="">Aucune école</option>
          @for (school of schools(); track school.id) {
            <option [value]="school.id">
              {{ school.name }}
            </option>
          }
          <option value="other">Autre école</option>
        </select>
      </div>

      @if (showOtherSchoolInput()) {
        <div class="form-group other-school-group">
          <label for="otherSchoolName">Nom de l'école *</label>
          <input
            id="otherSchoolName"
            type="text"
            [value]="otherSchoolName()"
            (input)="otherSchoolName.set($any($event.target).value)"
            class="form-control"
            placeholder="Entrez le nom de l'école"
          />
        </div>
      }

      <div class="form-group">
        <app-school-level-select
          [label]="'Niveau scolaire'"
          [required]="false"
          formControlName="school_level"
        />
      </div>

      <div class="form-group">
        <label for="notes">Notes</label>
        <textarea
          id="notes"
          formControlName="notes"
          class="form-control"
          rows="4"
          placeholder="Informations complémentaires sur l'enfant..."
        ></textarea>
      </div>

      <app-avatar-pin-generator
        [initialAvatarSeed]="avatarSeed()"
        [initialAvatarStyle]="avatarStyle()"
        [initialLoginPin]="loginPin()"
        [childId]="currentChildId() || null"
        (avatarSeedChange)="onAvatarSeedChange($event)"
        (avatarStyleChange)="onAvatarStyleChange($event)"
        (loginPinChange)="onLoginPinChange($event)"
        (validationChange)="onValidationChange($event)"
      />

      <div class="form-actions">
        <button 
          type="submit" 
          [disabled]="childForm.invalid || isLoading() || !avatarPinValid()" 
          class="btn btn-primary"
          [class.btn-add]="isCreating()"
          [class.btn-edit]="!isCreating()">
          @if (isLoading()) {
            <span class="spinner"></span>
          }
          <span>{{ buttonText() }}</span>
        </button>
        @if (!isCreating()) {
          <button type="button" (click)="onCancel()" class="btn btn-secondary">
            Annuler
          </button>
        }
      </div>
    </form>
  }
</div>

