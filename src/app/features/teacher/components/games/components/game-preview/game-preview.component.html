@if (isOpen) {
  <div 
    class="preview-backdrop" 
    (click)="onBackdropClick($event)"
    (keydown.escape)="close()"
    role="dialog"
    aria-modal="true"
    tabindex="-1">
    <div class="preview-container" (click)="$event.stopPropagation()" (keydown.escape)="close()" tabindex="0">
      <div class="preview-header">
        <h2 class="preview-title">üéÆ Pr√©visualisation du jeu</h2>
        <button 
          class="preview-close"
          type="button"
          (click)="close()"
          aria-label="Fermer la pr√©visualisation">
          √ó
        </button>
      </div>

      <div class="preview-body">
        <!-- Instructions et Question -->
        @if (globalFields?.instructions) {
          <div class="game-instructions">
            <strong>Instructions:</strong> {{ globalFields?.instructions }}
          </div>
        }

        @if (globalFields?.question) {
          <div class="game-question">
            <strong>Question:</strong> {{ globalFields?.question }}
          </div>
        }

        <!-- Aides -->
        @if (hasAides()) {
          <div class="game-aides">
            <strong>Aides:</strong>
            <ul>
              @for (aide of getAides(); track aide) {
                <li>{{ aide }}</li>
              }
            </ul>
          </div>
        }

        <!-- QCM -->
        @if (qcmData) {
          <div class="preview-content qcm-preview">
            <app-qcm-game
              [qcmData]="qcmData"
              [showResult]="isSubmitted()"
              [disabled]="false"
              (answerSelected)="onQcmAnswerSelected($event)"
              (validated)="onQcmValidated($event)">
            </app-qcm-game>
          </div>
        }

        <!-- Case Vide -->
        @if (caseVideData) {
          <div class="preview-content case-vide-preview">
            @if (isSubmitted() && isCorrect() !== null) {
              <div class="result-message" [class.correct]="isCorrect()" [class.incorrect]="!isCorrect()">
                @if (isCorrect()) {
                  ‚úÖ Bonne r√©ponse !
                } @else {
                  ‚ùå Mauvaise r√©ponse. La bonne r√©ponse √©tait : "{{ getCaseVideReponseValide() }}"
                }
              </div>
            }
            <div class="case-vide-sentence">
              <span>{{ caseVideData.debut_phrase }}</span>
              <input 
                type="text" 
                [value]="userAnswer()"
                (input)="userAnswer.set($any($event.target).value)"
                [disabled]="isSubmitted()"
                placeholder="?"
                class="case-vide-input">
              <span>{{ caseVideData.fin_phrase }}</span>
            </div>
            <button class="btn btn-primary" (click)="submitCaseVide()" [disabled]="isSubmitted() || !userAnswer().trim()">
              Valider
            </button>
            @if (isSubmitted()) {
              <button class="btn btn-secondary" (click)="reset()">R√©essayer</button>
            }
          </div>
        }

        <!-- R√©ponse Libre -->
        @if (reponseLibreData) {
          <div class="preview-content reponse-libre-preview">
            @if (isSubmitted() && isCorrect() !== null) {
              <div class="result-message" [class.correct]="isCorrect()" [class.incorrect]="!isCorrect()">
                @if (isCorrect()) {
                  ‚úÖ Bonne r√©ponse !
                } @else {
                  ‚ùå Mauvaise r√©ponse. La bonne r√©ponse √©tait : "{{ getReponseLibreReponseValide() }}"
                }
              </div>
            }
            <div class="reponse-libre-input">
              <input 
                type="text" 
                [value]="userAnswer()"
                (input)="userAnswer.set($any($event.target).value)"
                [disabled]="isSubmitted()"
                placeholder="Votre r√©ponse..."
                class="text-input">
            </div>
            <button class="btn btn-primary" (click)="submitReponseLibre()" [disabled]="isSubmitted() || !userAnswer().trim()">
              Valider
            </button>
            @if (isSubmitted()) {
              <button class="btn btn-secondary" (click)="reset()">R√©essayer</button>
            }
          </div>
        }

        <!-- Liens -->
        @if (liensData) {
          <div class="preview-content liens-preview">
            @if (isSubmitted() && isCorrect() !== null) {
              <div class="result-message" [class.correct]="isCorrect()" [class.incorrect]="!isCorrect()">
                @if (isCorrect()) {
                  ‚úÖ Tous les liens sont corrects !
                } @else {
                  ‚ùå Certains liens sont incorrects.
                }
              </div>
            }
            <div class="liens-grid">
              <div class="mots-column">
                <h4>Mots</h4>
                @for (mot of getLiensMots(); track mot) {
                  <div 
                    class="mot-item"
                    [class.selected]="isMotSelected(mot)"
                    [class.linked]="getReponseForMot(mot)"
                    (click)="selectMot(mot)"
                    [class.disabled]="isSubmitted()">
                    {{ mot }}
                    @if (getReponseForMot(mot)) {
                      <span class="link-indicator">‚Üí {{ getReponseForMot(mot) }}</span>
                    }
                  </div>
                }
              </div>
              <div class="reponses-column">
                <h4>R√©ponses</h4>
                @for (reponse of getLiensReponses(); track reponse) {
                  <div 
                    class="reponse-item"
                    [class.selected]="findMotForReponse(reponse) && isLinkSelected(findMotForReponse(reponse), reponse)"
                    (click)="selectReponse(reponse)"
                    [class.disabled]="isSubmitted()">
                    {{ reponse }}
                </div>
                }
              </div>
            </div>
            @if (selectedMotForLink()) {
              <p class="hint">S√©lectionnez une r√©ponse pour lier avec "{{ selectedMotForLink() }}"</p>
            }
            <button class="btn btn-primary" (click)="submitLiens()" [disabled]="isSubmitted()">
              Valider
            </button>
            @if (isSubmitted()) {
              <button class="btn btn-secondary" (click)="reset()">R√©essayer</button>
            }
          </div>
        }

        <!-- Chronologie -->
        @if (chronologieData) {
          <div class="preview-content chronologie-preview">
            <app-chronologie-game
              [chronologieData]="chronologieData"
              [showResult]="isSubmitted()"
              [disabled]="false"
              (orderChanged)="onChronologieOrderChanged($event)"
              (validated)="onChronologieValidated($event)">
            </app-chronologie-game>
          </div>
        }
      </div>

      <div class="preview-footer">
        <button class="btn btn-secondary" (click)="close()">Fermer</button>
      </div>
    </div>
  </div>
}

