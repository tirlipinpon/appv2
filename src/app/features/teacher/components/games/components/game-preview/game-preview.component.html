@if (isOpen()) {
  <div 
    class="preview-backdrop" 
    (click)="onBackdropClick($event)"
    (keydown.escape)="close()"
    role="dialog"
    aria-modal="true"
    tabindex="-1">
    <div class="preview-container" (click)="$event.stopPropagation()" (keydown.escape)="close()" tabindex="0">
      <div class="preview-header">
        <h2 class="preview-title">üéÆ Pr√©visualisation du jeu</h2>
        <button 
          class="preview-close"
          type="button"
          (click)="close()"
          aria-label="Fermer la pr√©visualisation">
          √ó
        </button>
      </div>

      <div class="preview-body">
        <!-- Instructions et Question -->
        @if (globalFields?.instructions) {
          <div class="game-instructions">
            <strong>Instructions:</strong> {{ globalFields?.instructions }}
          </div>
        }

        @if (globalFields?.question) {
          <div class="game-question">
            <strong>Question:</strong> {{ globalFields?.question }}
          </div>
        }

        <!-- Aides -->
        @if (hasAides()) {
          <div class="game-aides">
            <strong>Aides:</strong>
            <ul>
              @for (aide of getAides(); track aide) {
                <li>{{ aide }}</li>
              }
            </ul>
          </div>
        }

        <!-- QCM -->
        @if (qcmData) {
          <div class="preview-content qcm-preview">
            <app-qcm-game
              [qcmData]="qcmData"
              [showResult]="isSubmitted()"
              [disabled]="false"
              (answerSelected)="onQcmAnswerSelected($event)"
              (validated)="onQcmValidated($event)">
            </app-qcm-game>
          </div>
        }

        <!-- Case Vide -->
        @if (caseVideData) {
          <div class="preview-content case-vide-preview">
            @if (caseVideData.texte && caseVideData.banque_mots) {
              <!-- Nouveau format : Drag and Drop -->
              @if (isSubmitted() && isCorrect() !== null) {
                <div class="result-message" [class.correct]="isCorrect()" [class.incorrect]="!isCorrect()">
                  @if (isCorrect()) {
                    ‚úÖ Toutes les r√©ponses sont correctes !
                  } @else {
                    ‚ùå Certaines r√©ponses sont incorrectes.
                  }
                </div>
              }

              <!-- Banque de mots -->
              <div class="banque-mots-container">
                <h4>Banque de mots</h4>
                <div 
                  cdkDropList
                  id="banque-mots"
                  class="banque-mots-list"
                  [cdkDropListData]="getAvailableWords()"
                  [cdkDropListConnectedTo]="connectedDropListIds()">
                  @for (word of getAvailableWords(); track word) {
                    <div 
                      class="word-tag"
                      cdkDrag
                      [cdkDragData]="word"
                      [class.used]="isWordUsed(word)">
                      {{ word }}
                    </div>
                  }
                </div>
              </div>

              <!-- Texte avec cases vides -->
              <div class="texte-with-cases">
                @for (part of parseTexteWithCases(); track $index) {
                  @if (part.type === 'text') {
                    <span class="texte-part">{{ part.content }}</span>
                  } @else if (part.type === 'case' && part.index) {
                    <div 
                      cdkDropList
                      [id]="'case-' + part.index"
                      class="case-vide-drop"
                      [cdkDropListData]="getCaseDropListData(part.index)"
                      [cdkDropListConnectedTo]="connectedDropListIds()"
                      (cdkDropListDropped)="onWordDrop($event, part.index)"
                      [class.filled]="getWordInCase(part.index)"
                      [class.correct]="isCaseCorrect(part.index) === true"
                      [class.incorrect]="isCaseCorrect(part.index) === false">
                      @if (getWordInCase(part.index)) {
                        <div class="case-word" cdkDrag [cdkDragData]="getWordInCase(part.index)">
                          {{ getWordInCase(part.index) }}
                          @if (!isSubmitted()) {
                            <button 
                              type="button" 
                              class="btn-remove-word"
                              (click)="removeWordFromCase(part.index); $event.stopPropagation()"
                              title="Retirer ce mot">
                              √ó
                            </button>
                          }
                        </div>
                      } @else {
                        <span class="case-placeholder">{{ part.content }}</span>
                      }
                    </div>
                  }
                }
              </div>

              <button 
                class="btn btn-primary" 
                (click)="submitCaseVide()" 
                [disabled]="isSubmitted() || userCaseVideAnswers().size !== (caseVideData.cases_vides?.length || 0)">
                Valider
              </button>
              @if (isSubmitted()) {
                <button class="btn btn-secondary" (click)="reset()">R√©essayer</button>
              }
            } @else {
              <!-- Ancien format : Input texte simple -->
              @if (isSubmitted() && isCorrect() !== null) {
                <div class="result-message" [class.correct]="isCorrect()" [class.incorrect]="!isCorrect()">
                  @if (isCorrect()) {
                    ‚úÖ Bonne r√©ponse !
                  } @else {
                    ‚ùå Mauvaise r√©ponse. La bonne r√©ponse √©tait : "{{ getCaseVideReponseValide() }}"
                  }
                </div>
              }
              <div class="case-vide-sentence">
                <span>{{ caseVideData.debut_phrase }}</span>
                <input 
                  type="text" 
                  [value]="userAnswer()"
                  (input)="userAnswer.set($any($event.target).value)"
                  [disabled]="isSubmitted()"
                  placeholder="?"
                  class="case-vide-input">
                <span>{{ caseVideData.fin_phrase }}</span>
              </div>
              <button class="btn btn-primary" (click)="submitCaseVide()" [disabled]="isSubmitted() || !userAnswer().trim()">
                Valider
              </button>
              @if (isSubmitted()) {
                <button class="btn btn-secondary" (click)="reset()">R√©essayer</button>
              }
            }
          </div>
        }

        <!-- R√©ponse Libre -->
        @if (reponseLibreData) {
          <div class="preview-content reponse-libre-preview">
            @if (isSubmitted() && isCorrect() !== null) {
              <div class="result-message" [class.correct]="isCorrect()" [class.incorrect]="!isCorrect()">
                @if (isCorrect()) {
                  ‚úÖ Bonne r√©ponse !
                } @else {
                  ‚ùå Mauvaise r√©ponse. La bonne r√©ponse √©tait : "{{ getReponseLibreReponseValide() }}"
                }
              </div>
            }
            <div class="reponse-libre-input">
              <app-letter-by-letter-input
                [targetWord]="getReponseLibreReponseValide()"
                [allowHyphen]="true"
                [disabled]="isSubmitted()"
                (wordChange)="userAnswer.set($event)"
                (wordComplete)="submitReponseLibre()">
              </app-letter-by-letter-input>
            </div>
            <button class="btn btn-primary" (click)="submitReponseLibre()" [disabled]="isSubmitted() || !userAnswer().trim()">
              Valider
            </button>
            @if (isSubmitted()) {
              <button class="btn btn-secondary" (click)="reset()">R√©essayer</button>
            }
          </div>
        }

        <!-- Liens -->
        @if (liensData) {
          <div class="preview-content liens-preview">
            @if (isSubmitted() && isCorrect() !== null) {
              <div class="result-message" [class.correct]="isCorrect()" [class.incorrect]="!isCorrect()">
                @if (isCorrect()) {
                  ‚úÖ Tous les liens sont corrects !
                } @else {
                  ‚ùå Certains liens sont incorrects.
                }
              </div>
            }
            <div class="liens-grid-container">
              <div class="liens-grid" #liensGrid>
                <svg #linksSvg class="links-svg" xmlns="http://www.w3.org/2000/svg">
                  @for (linkPath of getLinkPaths(); track linkPath.mot + linkPath.reponse) {
                    <path 
                      [attr.d]="linkPath.path" 
                      class="link-line"
                      [class.correct]="isSubmitted() && isCorrect()"
                      [class.incorrect]="isSubmitted() && !isCorrect()"
                      fill="none"
                      stroke-width="2"
                      stroke-linecap="round">
                    </path>
                  }
                </svg>
                <div class="mots-column">
                  <h4>Mots</h4>
                  @for (mot of getLiensMots(); track mot) {
                    <div 
                      class="mot-item"
                      [attr.data-mot]="mot"
                      [class.selected]="isMotSelected(mot)"
                      [class.linked]="getReponseForMot(mot)"
                      (click)="selectMot(mot)"
                      [class.disabled]="isSubmitted()">
                      <span class="mot-text">{{ mot }}</span>
                      <span class="link-circle"></span>
                    </div>
                  }
                </div>
                <div class="reponses-column">
                  <h4>R√©ponses</h4>
                  @for (reponse of getLiensReponses(); track reponse) {
                    <div 
                      class="reponse-item"
                      [attr.data-reponse]="reponse"
                      [class.selected]="findMotForReponse(reponse) && isLinkSelected(findMotForReponse(reponse), reponse)"
                      (click)="selectReponse(reponse)"
                      [class.disabled]="isSubmitted()">
                      <span class="link-circle"></span>
                      <span class="reponse-text">{{ reponse }}</span>
                    </div>
                  }
                </div>
              </div>
            </div>
            @if (selectedMotForLink()) {
              <p class="hint">S√©lectionnez une r√©ponse pour lier avec "{{ selectedMotForLink() }}"</p>
            }
            <button class="btn btn-primary" (click)="submitLiens()" [disabled]="isSubmitted()">
              Valider
            </button>
            @if (isSubmitted()) {
              <button class="btn btn-secondary" (click)="reset()">R√©essayer</button>
            }
          </div>
        }

        <!-- Chronologie -->
        @if (chronologieData) {
          <div class="preview-content chronologie-preview">
            <app-chronologie-game
              [chronologieData]="chronologieData"
              [showResult]="isSubmitted()"
              [disabled]="false"
              (orderChanged)="onChronologieOrderChanged($event)"
              (validated)="onChronologieValidated($event)">
            </app-chronologie-game>
          </div>
        }

        <!-- Vrai/Faux -->
        @if (vraiFauxData) {
          <div class="preview-content vrai-faux-preview">
            @if (isSubmitted() && isCorrect() !== null) {
              <div class="result-message" [class.correct]="isCorrect()" [class.incorrect]="!isCorrect()">
                @if (isCorrect()) {
                  ‚úÖ Toutes les r√©ponses sont correctes !
                } @else {
                  ‚ùå Certaines r√©ponses sont incorrectes.
                }
              </div>
            }
            <div class="vrai-faux-grid">
              <div class="vrai-faux-header">
                <div class="header-column vrai-column">Vrai</div>
                <div class="header-column enonce-column"></div>
                <div class="header-column faux-column">Faux</div>
              </div>
              @for (enonce of getVraiFauxEnonces(); track enonce.texte) {
                <div class="vrai-faux-row">
                  <button
                    type="button"
                    class="vrai-button"
                    [class.selected]="isVraiFauxAnswerSelected(enonce.texte, true)"
                    [class.correct]="isSubmitted() && isVraiFauxCorrect(enonce.texte) === true && isVraiFauxAnswerSelected(enonce.texte, true)"
                    [class.incorrect]="isSubmitted() && isVraiFauxCorrect(enonce.texte) === false && isVraiFauxAnswerSelected(enonce.texte, true)"
                    (click)="selectVraiFauxAnswer(enonce.texte, true)"
                    [disabled]="isSubmitted()">
                    <span class="circle"></span>
                  </button>
                  <div class="enonce-text">{{ enonce.texte }}</div>
                  <button
                    type="button"
                    class="faux-button"
                    [class.selected]="isVraiFauxAnswerSelected(enonce.texte, false)"
                    [class.correct]="isSubmitted() && isVraiFauxCorrect(enonce.texte) === true && isVraiFauxAnswerSelected(enonce.texte, false)"
                    [class.incorrect]="isSubmitted() && isVraiFauxCorrect(enonce.texte) === false && isVraiFauxAnswerSelected(enonce.texte, false)"
                    (click)="selectVraiFauxAnswer(enonce.texte, false)"
                    [disabled]="isSubmitted()">
                    <span class="circle"></span>
                  </button>
                </div>
              }
            </div>
            <button 
              class="btn btn-primary" 
              (click)="submitVraiFaux()" 
              [disabled]="isSubmitted() || userVraiFauxAnswers().size !== getVraiFauxEnonces().length">
              Valider
            </button>
            @if (isSubmitted()) {
              <button class="btn btn-secondary" (click)="reset()">R√©essayer</button>
            }
          </div>
        }

        <!-- Memory -->
        @if (memoryData) {
          <div class="preview-content memory-preview">
            @if (isSubmitted() && isCorrect() !== null) {
              <div class="result-message" [class.correct]="isCorrect()" [class.incorrect]="!isCorrect()">
                @if (isCorrect()) {
                  ‚úÖ Toutes les paires ont √©t√© trouv√©es !
                } @else {
                  ‚ùå Le jeu n'est pas encore termin√©.
                }
              </div>
            }
            <app-memory-game
              [memoryData]="memoryData"
              [showResult]="isSubmitted()"
              [disabled]="false"
              (validated)="onMemoryValidated($event)">
            </app-memory-game>
            @if (isSubmitted()) {
              <button class="btn btn-secondary" (click)="reset()">R√©essayer</button>
            }
          </div>
        }
      </div>

      <div class="preview-footer">
        <button class="btn btn-secondary" (click)="close()">Fermer</button>
      </div>
    </div>
  </div>
}

