<li class="game-item" [class.editing]="isEditing()" [class.expanded]="isExpanded()">
  <!-- Header cliquable pour toggle -->
  <div class="game-header-toggle" (click)="toggleExpanded()">
    <div class="game-header-info">
      <h4>{{ game.name }}</h4>
      <span class="game-type-badge">{{ currentGameTypeName() }}</span>
    </div>
    <button type="button" class="toggle-btn" [attr.aria-expanded]="isExpanded()">
      {{ isExpanded() ? 'âˆ’' : '+' }}
    </button>
  </div>

  <!-- Contenu visible mÃªme quand fermÃ© (titre, instructions, question) -->
  <div class="game-preview-summary">
    @if (game.instructions) {
      <p class="game-instructions">{{ game.instructions }}</p>
    }
    @if (game.question) {
      <h5 class="game-question">{{ game.question }}</h5>
    }
    @if (!isEditing()) {
      <div class="game-actions-summary">
        <button class="btn btn-secondary btn-small" (click)="toggleEdit(); $event.stopPropagation()">
          âœï¸ Modifier
        </button>
        <button class="btn btn-danger btn-small" (click)="onDeleteClick(); $event.stopPropagation()">
          ğŸ—‘ï¸ Supprimer
        </button>
      </div>
    }
  </div>

  <!-- Mode lecture - Contenu dÃ©taillÃ© (affichÃ© seulement si expanded) -->
  @if (!isEditing() && isExpanded()) {
    <div class="game-preview">
      <div class="game-content">
        <div class="game-metadata">
          <strong>Contenu:</strong> {{ formatMetadataForDisplay() }}
        </div>

        @if (game.aides && game.aides.length > 0) {
          <div class="game-aides">
            <strong>Aides ({{ game.aides.length }}):</strong>
            <ul>
              @for (aide of game.aides; track aide) {
                <li>{{ aide }}</li>
              }
            </ul>
          </div>
        }
      </div>

      <div class="game-actions">
        <button class="btn btn-secondary" (click)="toggleEdit(); $event.stopPropagation()">
          âœï¸ Modifier
        </button>
        <button class="btn btn-danger" (click)="onDeleteClick(); $event.stopPropagation()">
          ğŸ—‘ï¸ Supprimer
        </button>
      </div>
    </div>
  }

  <!-- Mode Ã©dition - Toujours affichÃ© -->
  @if (isEditing()) {
    <div class="game-edit">
      <div class="edit-notice">
        âš ï¸ Mode Ã©dition - Utilisez le formulaire ci-dessous pour modifier le jeu
      </div>

      <!-- Champs globaux (instructions, question, aides) -->
      <app-game-global-fields
        [initialData]="initialGlobalFields()"
        (dataChange)="onGlobalFieldsChange($event)"
        (validityChange)="onGlobalFieldsValidityChange()">
      </app-game-global-fields>

      <hr class="form-divider">

      <!-- Formulaires spÃ©cifiques pour chaque type -->
      @if (currentGameTypeName().toLowerCase() === 'qcm') {
        <app-qcm-form 
          [initialData]="getInitialDataForQcm()"
          (dataChange)="onGameDataChange($event)"
          (validityChange)="onGameValidityChange($event)">
        </app-qcm-form>
      }

      @if (currentGameTypeName().toLowerCase() === 'case vide') {
        <app-case-vide-form 
          [initialData]="getInitialDataForCaseVide()"
          (dataChange)="onGameDataChange($event)"
          (validityChange)="onGameValidityChange($event)">
        </app-case-vide-form>
      }

      @if (currentGameTypeName().toLowerCase() === 'reponse libre') {
        <app-reponse-libre-form 
          [initialData]="getInitialDataForReponseLibre()"
          (dataChange)="onGameDataChange($event)"
          (validityChange)="onGameValidityChange($event)">
        </app-reponse-libre-form>
      }

      @if (currentGameTypeName().toLowerCase() === 'liens') {
        <app-liens-form 
          [initialData]="getInitialDataForLiens()"
          (dataChange)="onGameDataChange($event)"
          (validityChange)="onGameValidityChange($event)">
        </app-liens-form>
      }

      @if (currentGameTypeName().toLowerCase() === 'chronologie') {
        <app-chronologie-form 
          [initialData]="getInitialDataForChronologie()"
          (dataChange)="onGameDataChange($event)"
          (validityChange)="onGameValidityChange($event)">
        </app-chronologie-form>
      }

      @if (currentGameTypeName().toLowerCase() === 'vrai/faux') {
        <app-vrai-faux-form 
          [initialData]="getInitialDataForVraiFaux()"
          (dataChange)="onGameDataChange($event)"
          (validityChange)="onGameValidityChange($event)">
        </app-vrai-faux-form>
      }

      @if (currentGameTypeName().toLowerCase() === 'memory') {
        <app-memory-form 
          [initialData]="getInitialDataForMemory()"
          (dataChange)="onGameDataChange($event)"
          (validityChange)="onGameValidityChange($event)">
        </app-memory-form>
      }

      <div class="edit-actions">
        <button class="btn btn-primary" (click)="saveEdit()" [disabled]="!gameSpecificValid()">
          âœ… Enregistrer
        </button>
        <button class="btn btn-info" (click)="openPreview()" [disabled]="!gameSpecificValid()">
          ğŸ‘ï¸ PrÃ©visualiser
        </button>
        <button class="btn btn-secondary" (click)="cancelEdit()">
          âŒ Annuler
        </button>
        <button class="btn btn-danger" (click)="onDeleteClick()">
          ğŸ—‘ï¸ Supprimer
        </button>
      </div>
    </div>
  }
</li>

<!-- PrÃ©visualisation du jeu -->
<app-game-preview
  [isOpen]="previewIsOpen()"
  [gameTypeName]="currentGameTypeName()"
  [globalFields]="currentGlobalFields()"
  [gameData]="gameSpecificData()"
  (closed)="closePreview()">
</app-game-preview>

