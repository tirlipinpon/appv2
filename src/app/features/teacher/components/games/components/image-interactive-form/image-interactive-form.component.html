<div class="image-interactive-form">
  <form [formGroup]="form">
    <!-- Upload d'image -->
    <div class="upload-section">
      <label for="imageFile" class="upload-label">
        <span class="upload-icon">üì∑</span>
        <span>T√©l√©charger une image</span>
      </label>
      <input
        type="file"
        id="imageFile"
        formControlName="imageFile"
        accept="image/jpeg,image/jpg,image/png,image/webp,image/gif"
        (change)="onFileSelected($event)"
        class="file-input"
      />
      @if (imageUrl()) {
        <p class="image-info">
          Image charg√©e : {{ imageWidth() }} √ó {{ imageHeight() }}px
        </p>
      }
    </div>

    <!-- Conteneur de l'image avec zones -->
    @if (imageUrl()) {
      <div class="image-editor">
        <div class="editor-controls">
          <button
            type="button"
            class="btn-mode"
            [class.active]="editMode() === 'draw'"
            (click)="editMode.set('draw')"
          >
            ‚úèÔ∏è Dessiner une zone
          </button>
          <button
            type="button"
            class="btn-mode"
            [class.active]="editMode() === 'select'"
            (click)="editMode.set('select')"
          >
            üëÜ S√©lectionner
          </button>
        </div>

        <div
          #imageContainer
          class="image-container"
          (mousedown)="onMouseDown($event)"
          (mousemove)="onMouseMove($event)"
          (mouseup)="onMouseUp($event)"
          (mouseleave)="onMouseLeave()"
        >
          <img
            #imageElement
            [src]="imageUrl()!"
            [alt]="'Image interactive'"
            class="game-image"
            (load)="updateImageDimensions()"
          />

          <!-- Overlay des zones -->
          <div #zonesOverlay class="zones-overlay">
            <!-- Zone en cours de dessin (preview) -->
            @if (isDrawing() && getDrawingPreview(); as preview) {
              <div
                class="zone zone-preview"
                [style.left.px]="preview.x + imageOffsetX()"
                [style.top.px]="preview.y + imageOffsetY()"
                [style.width.px]="preview.width"
                [style.height.px]="preview.height"
              >
                <div class="zone-label">Nouvelle zone</div>
              </div>
            }
            
            <!-- Zones existantes -->
            @for (zone of zones(); track zone.id) {
              @if (getAbsolutePosition(zone); as pos) {
                <div
                  class="zone"
                  [class.selected]="isZoneSelected(zone.id)"
                  [class.correct]="zone.is_correct"
                  [class.incorrect]="!zone.is_correct"
                  [class.moving]="isMoving() && isZoneSelected(zone.id)"
                  [style.left.px]="pos.x"
                  [style.top.px]="pos.y"
                  [style.width.px]="pos.width"
                  [style.height.px]="pos.height"
                  (click)="selectZone(zone.id)"
                  [style.cursor]="editMode() === 'select' && isZoneSelected(zone.id) ? 'move' : 'default'"
                >
                  <div class="zone-label">
                    {{ zone.name || 'Zone' }}
                  </div>
                  <div class="zone-actions">
                    <button
                      type="button"
                      class="btn-zone-action"
                      [title]="zone.is_correct ? 'Marquer comme incorrecte' : 'Marquer comme correcte'"
                      (click)="toggleZoneCorrect(zone.id); $event.stopPropagation()"
                    >
                      {{ zone.is_correct ? '‚úì' : '‚úó' }}
                    </button>
                    <button
                      type="button"
                      class="btn-zone-action btn-delete"
                      title="Supprimer la zone"
                      (click)="deleteZone(zone.id); $event.stopPropagation()"
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                  
                  <!-- Poign√©es de redimensionnement (seulement en mode select et si la zone est s√©lectionn√©e) -->
                  @if (editMode() === 'select' && isZoneSelected(zone.id)) {
                    <div
                      class="resize-handle resize-handle-nw"
                      (mousedown)="onResizeHandleMouseDown($event, 'nw'); $event.stopPropagation()"
                      title="Redimensionner (coin nord-ouest)"
                    ></div>
                    <div
                      class="resize-handle resize-handle-ne"
                      (mousedown)="onResizeHandleMouseDown($event, 'ne'); $event.stopPropagation()"
                      title="Redimensionner (coin nord-est)"
                    ></div>
                    <div
                      class="resize-handle resize-handle-sw"
                      (mousedown)="onResizeHandleMouseDown($event, 'sw'); $event.stopPropagation()"
                      title="Redimensionner (coin sud-ouest)"
                    ></div>
                    <div
                      class="resize-handle resize-handle-se"
                      (mousedown)="onResizeHandleMouseDown($event, 'se'); $event.stopPropagation()"
                      title="Redimensionner (coin sud-est)"
                    ></div>
                  }
                </div>
              }
            }
          </div>
        </div>

        <!-- Liste des zones -->
        @if (zones().length > 0) {
          <div class="zones-list">
            <h4>Zones d√©finies ({{ zones().length }})</h4>
            <ul>
              @for (zone of zones(); track zone.id) {
                <li
                  class="zone-item"
                  [class.selected]="isZoneSelected(zone.id)"
                  [class.correct]="zone.is_correct"
                  [class.incorrect]="!zone.is_correct"
                  (click)="selectZone(zone.id)"
                >
                  <span class="zone-name">{{ zone.name || 'Zone sans nom' }}</span>
                  <span class="zone-status">
                    {{ zone.is_correct ? '‚úì Correcte' : '‚úó Incorrecte' }}
                  </span>
                  <div class="zone-item-actions">
                    <button
                      type="button"
                      class="btn-toggle-correct"
                      [title]="zone.is_correct ? 'Marquer comme incorrecte' : 'Marquer comme correcte'"
                      (click)="toggleZoneCorrect(zone.id); $event.stopPropagation()"
                    >
                      {{ zone.is_correct ? '‚úì' : '‚úó' }}
                    </button>
                    <button
                      type="button"
                      class="btn-delete-small"
                      title="Supprimer la zone"
                      (click)="deleteZone(zone.id); $event.stopPropagation()"
                    >
                      Supprimer
                    </button>
                  </div>
                </li>
              }
            </ul>
            <div class="validation-config">
              <label class="validation-config-label">
                <input
                  type="checkbox"
                  [checked]="requireAllCorrectZones()"
                  (change)="onRequireAllCorrectZonesChange($any($event.target).checked)"
                  class="validation-config-checkbox"
                />
                <span class="validation-config-text">
                  Toutes les zones correctes sont obligatoires
                </span>
              </label>
              <p class="validation-config-help">
                @if (requireAllCorrectZones()) {
                  Le joueur devra cliquer sur toutes les zones correctes pour gagner.
                } @else {
                  Le joueur devra cliquer sur au moins une zone correcte pour gagner.
                }
              </p>
            </div>
            <p class="help-text">
              üí° Astuce : Cliquez sur "Dessiner une zone" puis tracez un rectangle sur l'image pour cr√©er une zone cliquable. Vous pouvez d√©finir plusieurs zones correctes en cliquant sur le bouton ‚úì/‚úó pour chaque zone.
            </p>
          </div>
        } @else {
          <p class="help-text">
            üí° T√©l√©chargez une image puis dessinez des zones cliquables dessus.
          </p>
        }
      </div>
    }
  </form>
</div>

