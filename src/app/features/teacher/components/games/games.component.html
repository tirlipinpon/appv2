<div class="games-container">
  <a (click)="navigateToSubject($event)" class="btn-back">‚Üê Retour √† la mati√®re</a>
  <h1>Gestion des jeux</h1>
  
  @if (currentSubjectName()) {
    <div class="subject-info">
      <h2>Mati√®re : {{ currentSubjectName() }}</h2>
    </div>
  }

  <!-- Section G√©n√©ration IA -->
  <section class="ai-generation-section collapsible-section">
    <div class="section-header" (click)="toggleAIGeneration()">
      <h3>ü§ñ G√©n√©ration de jeux par IA</h3>
      <button type="button" class="toggle-btn" [attr.aria-expanded]="isAIGenerationExpanded()">
        {{ isAIGenerationExpanded() ? '‚àí' : '+' }}
      </button>
    </div>
    @if (isAIGenerationExpanded()) {
      <div class="section-content">
        <app-ai-game-generator-form
          [subjectId]="subjectId()!"
          [subjectName]="currentSubjectName()"
          [schoolYearLabel]="schoolYearLabel()"
          [isGenerating]="isGenerating()"
          [generationProgress]="generationProgress()"
          [generatedCount]="generatedGames().length"
          [gameTypes]="gameTypes()"
          (generate)="onGenerateGamesWithAI($event)">
        </app-ai-game-generator-form>

        <app-ai-generated-preview
          [generatedGames]="generatedGames()"
          [gameTypes]="gameTypes()"
          (edit)="onEditGeneratedGame($event)"
          (remove)="onRemoveGeneratedGame($event)"
          (updateGame)="onUpdateGeneratedGame($event)"
          (saveAll)="onSaveAllGeneratedGames()"
          (cancelAll)="onCancelAllGeneratedGames()">
        </app-ai-generated-preview>
      </div>
    }
  </section>

  <!-- S√©parateur visuel -->
  @if (generatedGames().length === 0) {
    <div class="section-divider">
      <span>OU</span>
    </div>
  }

  <div class="game-form-section collapsible-section">
    <div class="section-header" (click)="toggleManualCreation()">
      <h3>{{ isEditing() ? '‚úèÔ∏è Modifier le jeu' : '‚ûï Cr√©er un nouveau jeu' }}</h3>
      <button type="button" class="toggle-btn" [attr.aria-expanded]="isManualCreationExpanded()">
        {{ isManualCreationExpanded() ? '‚àí' : '+' }}
      </button>
    </div>
    @if (isManualCreationExpanded()) {
      <div class="section-content">
        <form [formGroup]="gameForm" (ngSubmit)="isEditing() ? update() : create()">
      <div class="form-group">
        <label for="game_type_id">Type de jeu *</label>
        <select id="game_type_id" formControlName="game_type_id" (change)="onGameTypeChange()">
          <option value="">S√©lectionner un type</option>
          @for (gt of gameTypes(); track gt.id) {
            <option [value]="gt.id">{{ gt.name }}</option>
          }
        </select>
        @if (gameForm.get('game_type_id')?.hasError('required') && gameForm.get('game_type_id')?.touched) {
          <span class="error-message">
            Le type de jeu est requis.
          </span>
        }
      </div>

      <!-- Champs globaux (instructions, question, aides) -->
      <app-game-global-fields
        [initialData]="initialGlobalFields()"
        (dataChange)="onGlobalFieldsChange($event)"
        (validityChange)="onGlobalFieldsValidityChange()">
      </app-game-global-fields>

      <!-- Composants sp√©cifiques selon le type de jeu -->
      @if (selectedGameTypeName()) {
        <div class="game-specific-form">
          <!-- Case vide -->
          @if (selectedGameTypeName() === 'case vide') {
            <app-case-vide-form
              [initialData]="getInitialDataForCaseVide()"
              (dataChange)="onGameDataChange($event)"
              (validityChange)="onGameValidityChange($event)">
            </app-case-vide-form>
          }

          <!-- R√©ponse libre -->
          @if (selectedGameTypeName() === 'reponse libre') {
            <app-reponse-libre-form
              [initialData]="getInitialDataForReponseLibre()"
              (dataChange)="onGameDataChange($event)"
              (validityChange)="onGameValidityChange($event)">
            </app-reponse-libre-form>
          }

          <!-- Liens -->
          @if (selectedGameTypeName() === 'liens') {
            <app-liens-form
              [initialData]="getInitialDataForLiens()"
              (dataChange)="onGameDataChange($event)"
              (validityChange)="onGameValidityChange($event)">
            </app-liens-form>
          }

          <!-- Chronologie -->
          @if (selectedGameTypeName() === 'chronologie') {
            <app-chronologie-form
              [initialData]="getInitialDataForChronologie()"
              (dataChange)="onGameDataChange($event)"
              (validityChange)="onGameValidityChange($event)">
            </app-chronologie-form>
          }

          <!-- QCM -->
          @if (selectedGameTypeName() === 'qcm') {
            <app-qcm-form
              [initialData]="getInitialDataForQcm()"
              (dataChange)="onGameDataChange($event)"
              (validityChange)="onGameValidityChange($event)">
            </app-qcm-form>
          }

          <!-- Vrai/Faux -->
          @if (selectedGameTypeName()?.toLowerCase() === 'vrai/faux') {
            <app-vrai-faux-form
              [initialData]="getInitialDataForVraiFaux()"
              (dataChange)="onGameDataChange($event)"
              (validityChange)="onGameValidityChange($event)">
            </app-vrai-faux-form>
          }

          <!-- Memory -->
          @if (selectedGameTypeName()?.toLowerCase() === 'memory') {
            <app-memory-form
              [initialData]="getInitialDataForMemory()"
              (dataChange)="onGameDataChange($event)"
              (validityChange)="onGameValidityChange($event)">
            </app-memory-form>
          }
        </div>
      }

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" [disabled]="gameForm.invalid || isLoading() || !gameSpecificValid()">
          {{ isEditing() ? 'Enregistrer' : 'Cr√©er' }}
        </button>
          @if (isEditing()) {
            <button type="button" class="btn btn-secondary" (click)="cancelEdit()">
              Annuler
            </button>
          }
        </div>
      </form>
    </div>
    }
  </div>

  <!-- Section Liste des jeux avec toggle -->
  <section class="games-list-section collapsible-section">
    <div class="section-header" (click)="toggleGamesList()">
      <h3>üìã Mes jeux ({{ games().length }})</h3>
      <button type="button" class="toggle-btn" [attr.aria-expanded]="isGamesListExpanded()">
        {{ isGamesListExpanded() ? '‚àí' : '+' }}
      </button>
    </div>
    @if (isGamesListExpanded()) {
      <div class="section-content">
        @if (isLoading()) {
          <div class="loading">Chargement...</div>
        }
        @if (!isLoading() && games().length === 0) {
          <div class="empty-state">
            <p>Aucun jeu cr√©√© pour cette mati√®re.</p>
          </div>
        }
        @if (!isLoading() && games().length > 0) {
          <ul class="games-list">
            @for (game of games(); track game.id) {
              <app-game-card
                [game]="game"
                [gameTypeName]="getGameTypeName(game.game_type_id)"
                [gameTypes]="gameTypes()"
                (update)="updateGameFromCard($event.gameId, $event.updates)"
                (delete)="delete($event)"
                (duplicate)="openDuplicateDialog($event)">
              </app-game-card>
            }
          </ul>
        }
      </div>
    }
  </section>

  <!-- Dialog de duplication -->
  @if (duplicateDialogOpen() && gameToDuplicate()) {
    <app-duplicate-game-dialog
      [game]="gameToDuplicate()!"
      [currentAssignment]="currentAssignment()"
      [availableSchools]="availableSchoolsForTeacher()"
      [availableAssignments]="subjectsStore.assignments()"
      [availableSubjects]="subjects()"
      [gameTypes]="gameTypes()"
      [gameTypeName]="getGameTypeName(gameToDuplicate()!.game_type_id)"
      (confirm)="onDuplicateGame($event)"
      (cancel)="onCancelDuplicate()">
    </app-duplicate-game-dialog>
  }
</div>
