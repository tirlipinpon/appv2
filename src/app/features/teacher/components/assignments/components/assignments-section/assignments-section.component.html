<div class="assignments-section">
  <!-- Affichage des erreurs -->
  <div *ngIf="hasError()" class="error-alert">
    <div class="error-content">
      <strong>âš ï¸ Erreur :</strong>
      <ul class="error-list">
        <li *ngFor="let error of error()">{{ error }}</li>
      </ul>
      <button type="button" class="error-close" (click)="clearError()" aria-label="Fermer">Ã—</button>
    </div>
  </div>

  <div class="assignments-header">
    <h3>Mes Affectations</h3>
    <div class="filters-container" *ngIf="hasAssignments()">
      <select
        *ngIf="uniqueSchools().length > 0"
        class="school-filter"
        [value]="selectedSchoolId() || ''"
        (change)="selectedSchoolId.set($any($event.target).value || null)">
        <option value="">Toutes les Ã©coles</option>
        <option *ngFor="let school of uniqueSchools()" [value]="school.id">
          {{ school.name }}
        </option>
      </select>
      <select
        *ngIf="shouldShowLevelFilter()"
        class="level-filter"
        [value]="selectedLevel() || ''"
        (change)="selectedLevel.set($any($event.target).value || null)">
        <option value="">Tous les niveaux</option>
        <option *ngFor="let level of availableLevels()" [value]="level">
          {{ getSchoolLevelLabel(level) }}
        </option>
      </select>
    </div>
  </div>

  <div *ngIf="hasFilteredAssignments()" class="assignments-list">
    <div *ngFor="let assignment of filteredAssignments()" class="assignment-card">
      <div class="assignment-info">
        <div class="assignment-header">
          <h4>{{ getAssignmentSubjectName(assignment) }}</h4>
          <button
            type="button"
            class="toggle-btn"
            (click)="toggleAssignment(assignment.id)"
            [attr.aria-expanded]="isAssignmentExpanded(assignment.id)"
            matTooltip="Afficher sous-catÃ©gories">
            {{ isAssignmentExpanded(assignment.id) ? 'â–¼' : 'â–¶' }}
          </button>
        </div>
        <p *ngIf="assignment.school_id">ğŸ“ Ã‰cole: {{ getSchoolName(assignment.school_id) }}</p>
        <p *ngIf="assignment.school_year_id">ğŸ“… AnnÃ©e: {{ assignment.school_year_id }}</p>
        <p *ngIf="assignment.school_level">ğŸ“ Niveau: {{ getSchoolLevelLabel(assignment.school_level) }}</p>
        <p>ğŸ‘¥ Enfants: {{ getStudentCount(assignment.id) }}</p>
        <app-games-stats-display
          *ngIf="assignment.subject_id"
          [subjectId]="assignment.subject_id">
        </app-games-stats-display>

        <!-- Toggle pour afficher les sous-catÃ©gories -->
        <div *ngIf="isAssignmentExpanded(assignment.id)" class="categories-toggle">
          <div *ngIf="isLoadingCategories(assignment.id)" class="loading-categories">
            Chargement des sous-catÃ©gories...
          </div>
          <div *ngIf="!isLoadingCategories(assignment.id)">
            <div *ngIf="getCategoriesForAssignment(assignment.id).length === 0" class="no-categories">
              <p>Aucune sous-catÃ©gorie pour cette matiÃ¨re.</p>
            </div>
            <div *ngFor="let category of getCategoriesForAssignment(assignment.id)" class="category-item">
              <div class="category-header">
                <strong>{{ category.name }}</strong>
                <span class="children-count">ğŸ‘¥ {{ getChildrenCountForCategory(category.id) }} enfant(s)</span>
              </div>
              <div *ngIf="category.description" class="category-description">
                {{ category.description }}
              </div>
              <div class="category-games">
                <span class="games-count">ğŸ® {{ getGamesForCategory(category.id).length }} jeu(x)</span>
                <a
                  *ngIf="assignment.subject_id"
                  [routerLink]="['/teacher-subjects', assignment.subject_id, 'games']"
                  [queryParams]="{ categoryId: category.id }"
                  class="btn btn-sm btn-link">
                  Voir les jeux
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="assignment-actions">
        <a
          [routerLink]="['/teacher-subjects', assignment.subject_id]"
          [queryParams]="{ school_id: assignment.school_id, school_level: assignment.school_level }"
          class="btn btn-secondary btn-sm">
          âœï¸ GÃ©rer
        </a>
        <a
          [routerLink]="['/teacher-subjects', assignment.subject_id, 'games']"
          class="btn btn-primary btn-sm">
          ğŸ® GÃ©rer les jeux
        </a>
        <button
          type="button"
          (click)="onTransferAssignment(assignment.id)"
          class="btn btn-info btn-sm">
          ğŸ”„ TransfÃ©rer
        </button>
        <button
          type="button"
          (click)="onDeleteAssignment(assignment.id)"
          class="btn btn-danger btn-sm">
          ğŸ—‘ï¸ Supprimer
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="hasAssignments() && !hasFilteredAssignments()" class="no-assignments">
    <p>Aucune affectation pour l'Ã©cole sÃ©lectionnÃ©e.</p>
  </div>
  <div *ngIf="!hasAssignments()" class="no-assignments">
    <p>Vous n'avez pas encore d'affectation.</p>
    <a
      routerLink="/teacher-assignments"
      [queryParams]="{ add: 'true' }"
      class="btn btn-primary btn-add">
      â• Ajouter une affectation
    </a>
  </div>
</div>

<!-- Dialog de transfert d'affectation -->
<app-transfer-assignment-dialog
  *ngIf="showTransferDialog() && selectedAssignmentForTransfer()"
  [assignment]="selectedAssignmentForTransfer()!"
  [currentTeacherId]="getCurrentTeacherId() ?? ''"
  (confirm)="onTransferConfirm($event)"
  (cancel)="onTransferCancel()">
</app-transfer-assignment-dialog>

