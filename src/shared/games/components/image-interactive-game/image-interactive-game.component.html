<div class="image-interactive-game">
  @if (instructions) {
    <div class="game-instructions">
      <p>{{ instructions }}</p>
    </div>
  }
  @if (question) {
    <div class="game-question">
      <h2>{{ question }}</h2>
    </div>
  }
  <app-aide-section
    [aides]="aides"
    [aideImageUrl]="aideImageUrl"
    [aideVideoUrl]="aideVideoUrl">
  </app-aide-section>
  <div
    #imageContainer
    class="image-container"
    tabindex="0"
    role="button"
    [attr.aria-label]="'Image interactive avec zones cliquables'"
    (click)="onImageClick($event)"
    (keydown.enter)="onImageKeyDown($event)"
    (keydown.space)="onImageKeyDown($event)"
    [class.disabled]="disabled || isSubmitted()"
  >
    <img
      #imageElement
      [src]="imageData.image_url"
      [alt]="'Image interactive'"
      class="game-image"
      (load)="onImageLoad()"
      (error)="onImageError()"
    />
    @if (imageError()) {
      <div class="image-error-message">
        <p>⚠️ L'image n'a pas pu être chargée</p>
        <p class="error-details">L'image du jeu est introuvable sur le serveur.</p>
      </div>
    }

    <!-- Overlay des zones (invisible mais cliquable) -->
    <div class="zones-overlay">
      <!-- SVG pour les polygones -->
      <svg class="zones-svg" [style.width.px]="displayedImageWidth()" [style.height.px]="displayedImageHeight()" 
           [style.left.px]="imageOffsetX()" [style.top.px]="imageOffsetY()">
        @for (zone of imageData.zones; track zone.id) {
          @if (!isRectangle(zone)) {
            @if (getAbsolutePolygonPoints(zone); as polygonPoints) {
              @if (polygonPoints && polygonPoints.length > 0) {
                <g [class.clicked]="isZoneClicked(zone.id)"
                   [class.correct-zone]="isZoneCorrect(zone.id) && showResult && isSubmitted() && isCorrect()"
                   [class.visible]="isZoneClicked(zone.id)">
                  <polygon
                    [attr.points]="formatPolygonPoints(polygonPoints)"
                    class="zone-polygon"
                    [attr.fill]="isZoneClicked(zone.id) ? 'rgba(59, 130, 246, 0.3)' : (isZoneCorrect(zone.id) && showResult && isSubmitted() && isCorrect() ? 'rgba(34, 197, 94, 0.3)' : 'transparent')"
                    [attr.stroke]="isZoneCorrect(zone.id) && showResult && isSubmitted() && isCorrect() ? 'rgb(34, 197, 94)' : 'rgb(59, 130, 246)'"
                    [attr.stroke-width]="isZoneClicked(zone.id) ? '3' : '2'"
                    pointer-events="all"
                    [style.cursor]="disabled || isSubmitted() ? 'default' : 'pointer'"
                  />
                  @if (isZoneClicked(zone.id) && showResult && isZoneCorrect(zone.id) && isCorrect()) {
                    <text
                      [attr.x]="polygonPoints[0].x"
                      [attr.y]="polygonPoints[0].y - 10"
                      fill="rgb(34, 197, 94)"
                      font-size="24"
                      font-weight="bold"
                      text-anchor="middle"
                      pointer-events="none"
                    >
                      ✓
                    </text>
                  }
                </g>
              }
            }
          }
        }
      </svg>
      
      <!-- Zones rectangulaires (rétrocompatibilité) -->
      @for (zone of imageData.zones; track zone.id) {
        @if (isRectangle(zone) && getAbsolutePosition(zone); as pos) {
          <div
            class="zone"
            [class.clicked]="isZoneClicked(zone.id)"
            [class.correct-zone]="isZoneCorrect(zone.id) && showResult && isSubmitted() && isCorrect()"
            [class.visible]="isZoneClicked(zone.id)"
            [style.left.px]="pos.x"
            [style.top.px]="pos.y"
            [style.width.px]="pos.width"
            [style.height.px]="pos.height"
          >
            @if (isZoneClicked(zone.id) && showResult && isZoneCorrect(zone.id) && isCorrect()) {
              <div class="zone-marker">
                ✓
              </div>
            }
          </div>
        }
      }
    </div>
  </div>

  <!-- Message de résultat -->
  @if (resultMessage(); as message) {
    <div class="result-message" [class.correct]="isCorrect()" [class.incorrect]="!isCorrect()">
      {{ message }}
    </div>
  }

  <!-- Actions -->
  @if (!isSubmitted()) {
    <div class="actions">
      <button
        type="button"
        class="btn btn-primary"
        [disabled]="!canValidate() || disabled"
        (click)="validate()"
      >
        Valider
      </button>
    </div>
  }

  <app-game-error-actions
    [isSubmitted]="isSubmitted()"
    [isCorrect]="isCorrect()"
    (resetRequested)="reset()"
    (nextRequested)="nextRequested.emit()">
  </app-game-error-actions>

  <!-- Indicateur de zones cliquées -->
  <div class="zones-indicator">
    <p>
      Zones cliquées : {{ clickedZoneIds().size }} / {{ getCorrectZonesCount() }} correctes
    </p>
  </div>

</div>

